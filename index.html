<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeighBridge & Transport Billing System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        .title-box {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            text-align: center;
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        .form-label {
            font-weight: 500;
            color: #007bff;
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #e9ecef;
            position: sticky;
            top: 0;
        }
        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .calculated {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        .section-header {
            background-color: #2c3e50;
            color: white;
            padding: 8px 15px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .report-section {
            margin-top: 30px;
        }
        .report-table {
            margin-top: 15px;
        }
        .shift-header {
            background-color: #ffc107;
            font-weight: bold;
            text-align: center;
        }
        .customer-header {
            background-color: #d8bfd8;
            font-weight: bold;
        }
        .total-header {
            background-color: #90ee90;
            font-weight: bold;
        }
        .number-cell {
            text-align: right;
        }
        .dropdown-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .transaction-details {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
        }
        .transaction-row {
            border-bottom: 1px solid #dee2e6;
            padding: 5px 0;
        }
        .transaction-row:last-child {
            border-bottom: none;
        }
        @media (max-width: 768px) {
            .btn-container {
                flex-direction: column;
            }
            .dropdown-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        .report-actions {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .month-header {
            background-color: #2c3e50;
            color: white;
            padding: 8px 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        .vehicle-row {
            background-color: #f0f8ff;
        }
        .month-total {
            background-color: #e6f7ff;
            font-weight: bold;
        }
        .grand-total {
            background-color: #d4edda;
            font-weight: bold;
        }
        .btn-black {
            background-color: #000;
            color: white;
            border: none;
        }
        .btn-black:hover {
            background-color: #333;
            color: white;
        }
        .ftd-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .ftd-report-table th, .ftd-report-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .ftd-report-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .ftd-customer-row {
            background-color: #e6f2ff;
            font-weight: bold;
        }
        .ftd-total-row {
            background-color: #d4edda;
            font-weight: bold;
        }
        .ftd-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }
        .ftd-summary-table th, .ftd-summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .ftd-summary-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .ftd-summary-total {
            background-color: #d4edda;
            font-weight: bold;
        }
        .transaction-points {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }
        .transaction-point {
            padding: 3px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title-box">
            <h1 style="color: white; margin: 0;">Weighbridge & Transport Billing System</h1>
        </div>
        <form id="weighmentForm">
            <!-- Basic Information Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="accountingDate" class="form-label">Accounting Date</label>
                    <input type="date" class="form-control" id="accountingDate" required>
                </div>
                <div class="col-md-2">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="date" required>
                </div>
                <div class="col-md-2">
                    <label for="shift" class="form-label">Shift</label>
                    <select class="form-select" id="shift">
                        <option value="A-SHIFT">A-SHIFT</option>
                        <option value="B-SHIFT">B-SHIFT</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="weighmentSlipNo" class="form-label">Weighment Slip No</label>
                    <input type="text" class="form-control" id="weighmentSlipNo">
                </div>
                <div class="col-md-3">
                    <label for="deliveryChallanNo" class="form-label">DC No</label>
                    <input type="text" class="form-control" id="deliveryChallanNo">
                </div>
            </div>
            <!-- Royalty Information Section -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="royaltyPermitNo" class="form-label">Royalty Permit No</label>
                    <input type="text" class="form-control" id="royaltyPermitNo">
                </div>
                <div class="col-md-4">
                    <label for="permitQty" class="form-label">Permit Qty (CM)</label>
                    <input type="number" class="form-control" id="permitQty" step="0.01">
                </div>
                <div class="col-md-4">
                    <label for="royaltyRate" class="form-label">Royalty Rate</label>
                    <input type="number" class="form-control" id="royaltyRate" step="0.01">
                </div>
            </div>
            <!-- Client Information Section -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <label for="clientDropdown" class="form-label">Client Details</label>
                    <div class="dropdown-container">
                        <select class="form-select" id="clientDropdown">
                            <option value="">Select Client</option>
                            <option value="L & T P1 – Rambali">L & T P1 – Rambali</option>
                            <option value="L & T P2 – Rambali">L & T P2 – Rambali</option>
                            <option value="KEC – Rambali">KEC – Rambali</option>
                            <option value="JS Mining – Rambali">JS Mining – Rambali</option>
                            <option value="ITD – Rambali">ITD – Rambali</option>
                            <option value="Sowaparnika – Rambali">Sowaparnika – Rambali</option>
                            <option value="L & T Jio – Sindhiya">L & T Jio – Sindhiya</option>
                            <option value="Arabind – Shela Nagar">Arabind – Shela Nagar</option>
                            <option value="RKD – Shela Nagar">RKD – Shela Nagar</option>
                            <option value="Afcyan – Shela Ngr">Afcyan – Shela Ngr</option>
                            <option value="Bharath Verma – Airport">Bharath Verma – Airport</option>
                            <option value="Aparna RMC – Gajuwaka">Aparna RMC – Gajuwaka</option>
                            <option value="ACC RMC – Gajuwaka">ACC RMC – Gajuwaka</option>
                            <option value="Prisam RMC – Gajuwaka">Prisam RMC – Gajuwaka</option>
                            <option value="Nuvoco RMC – Gajuwaka">Nuvoco RMC – Gajuwaka</option>
                            <option value="Ultratech – Mindi">Ultratech – Mindi</option>
                            <option value="MK Builders – Madhurwada">MK Builders – Madhurwada</option>
                            <option value="North Star Homes – Madhurwada">North Star Homes – Madhurwada</option>
                            <option value="Coastal RMC – Madhurwada">Coastal RMC – Madhurwada</option>
                            <option value="Coastal RMC – Achututapuram">Coastal RMC – Achututapuram</option>
                            <option value="Vizag Port – Vizag Port">Vizag Port – Vizag Port</option>
                        </select>
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddClient">Add New</button>
                    </div>
                    <input type="text" class="form-control mt-2" id="clientDetails" placeholder="Or enter client details">
                </div>
            </div>
            <!-- Payment Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="paymentMode" class="form-label">Payment Terms</label>
                    <select class="form-select" id="paymentMode">
                        <option value="">Select Payment Mode</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit">Credit</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="advanceReceived" class="form-label">Advance Received</label>
                    <input type="number" class="form-control" id="advanceReceived" step="0.01">
                </div>
                <div class="col-md-4">
                    <label for="transportType" class="form-label">Transport Type</label>
                    <select class="form-select" id="transportType">
                        <option value="SGX Transport">SGX Transport</option>
                        <option value="Customer Transport">Customer Transport</option>
                    </select>
                </div>
            </div>
            <!-- Vehicle Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="vehicleNo" class="form-label">Vehicle No</label>
                    <div class="dropdown-container">
                        <select class="form-select" id="vehicleDropdown">
                            <option value="">Select Vehicle</option>
                            <option value="AP39UJ1166">AP39UJ1166</option>
                            <option value="AP39UJ2399">AP39UJ2399</option>
                        </select>
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddVehicle">Add New</button>
                    </div>
                    <input type="text" class="form-control mt-2" id="vehicleNo" placeholder="Or enter vehicle number">
                </div>
                <div class="col-md-4">
                    <label for="transportRate" class="form-label">Transport Rate</label>
                    <input type="number" class="form-control" id="transportRate" step="0.01">
                </div>
            </div>
            <!-- Material Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="materialType" class="form-label">Material</label>
                    <select class="form-select" id="materialType">
                        <option value="">Select Material</option>
                        <option value="10 MM">10 MM</option>
                        <option value="20 MM">20 MM</option>
                        <option value="V/SAND">V/SAND</option>
                        <option value="Scalping">Scalping</option>
                        <option value="P/Sand">P/Sand</option>
                        <option value="40MM">40MM</option>
                        <option value="GSB/WET MIX">GSB/WET MIX</option>
                        <option value="R/Sand">R/Sand</option>
                    </select>
                </div>
            </div>
            <!-- Weighment Details Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="grossWt" class="form-label">Gross WT</label>
                    <input type="number" class="form-control" id="grossWt" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="tareWt" class="form-label">Tare WT</label>
                    <input type="number" class="form-control" id="tareWt" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="netWt" class="form-label">NET WT (Calculated)</label>
                    <input type="number" class="form-control calculated" id="netWt" readonly>
                </div>
                <div class="col-md-3">
                    <label for="ratePerTone" class="form-label">Rate Per Tone</label>
                    <input type="number" class="form-control" id="ratePerTone" step="0.01">
                </div>
            </div>
            <!-- Financial Information Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="saleAmount" class="form-label">Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="saleAmount" readonly>
                </div>
                <div class="col-md-3">
                    <label for="cashReceived" class="form-label">Cash Received</label>
                    <input type="number" class="form-control" id="cashReceived" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="customerBalance" class="form-label">Customer Balance Amount (₹)</label>
                    <input type="number" class="form-control calculated" id="customerBalance" readonly>
                </div>
                <div class="col-md-3">
                    <label for="royaltyAmount" class="form-label">Royalty Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="royaltyAmount" readonly>
                </div>
            </div>
            <!-- Additional Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="transportAmount" class="form-label">Transport Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="transportAmount" readonly>
                </div>
                <div class="col-md-4">
                    <label for="totalAmount" class="form-label">Total Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="totalAmount" readonly>
                </div>
                <div class="col-md-4">
                    <label for="remarks" class="form-label">Remarks</label>
                    <input type="text" class="form-control" id="remarks">
                </div>
            </div>
            <!-- Action Buttons -->
            <div class="btn-container">
                <button type="submit" class="btn btn-success">Save Entry</button>
                <button type="button" class="btn btn-primary" id="btnExportExcel">Export to Excel</button>
                <button type="button" class="btn btn-warning" id="btnClearStorage">Clear All Data</button>
            </div>
        </form>
    </div>
    <div class="container">
        <h2>Data Records</h2>
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="mainDataTable">
                <thead>
                    <tr>
                        <th>S.NO</th>
                        <th>Accounting Date</th>
                        <th>Date</th>
                        <th>Shift</th>
                        <th>Weighment Slip No</th>
                        <th>DC No</th>
                        <th>Royalty Permit No</th>
                        <th>Permit Qty (CM)</th>
                        <th>Client Details</th>
                        <th>Payment Terms</th>
                        <th>Transport Type</th>
                        <th>Vehicle No</th>
                        <th>Material</th>
                        <th>Gross WT</th>
                        <th>Tare WT</th>
                        <th>NET WT</th>
                        <th>Rate Per Tone</th>
                        <th>Amount</th>
                        <th>Cash Received</th>
                        <th>Advance Received</th>
                        <th>Customer Balance</th>
                        <th>Remarks</th>
                        <th>Royalty Rate</th>
                        <th>Royalty Amount</th>
                        <th>Transport Rate</th>
                        <th>Transport Amount</th>
                        <th>Total Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recordsTable">
                    <tr>
                        <td colspan="28" class="text-center">No records found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Reports Section -->
    <div class="container report-section">
        <h2>Reports</h2>
        <!-- Dispatch Vehicle Wise Planning Report -->
        <div class="section-header">Dispatch Vehicle Wise Planning Report</div>
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="dispatchReportDate" class="form-label">Select Date for Report</label>
                <input type="date" class="form-control" id="dispatchReportDate">
            </div>
            <div class="col-md-3">
                <label for="dispatchReportShift" class="form-label">Select Shift</label>
                <select class="form-select" id="dispatchReportShift">
                    <option value="A-SHIFT">A-SHIFT</option>
                    <option value="B-SHIFT">B-SHIFT</option>
                    <option value="ALL">FULL DAY</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btnDispatchReport">Generate Dispatch Report</button>
            </div>
        </div>
        <div class="report-actions" id="dispatchReportActions" style="display: none;">
            <button type="button" class="btn btn-success" id="btnDownloadDispatchPDF">Download PDF Report</button>
            <button type="button" class="btn btn-primary" id="btnDownloadDispatchExcel">Download Excel Report</button>
        </div>
        <div class="table-responsive">
            <div id="dispatchReportContainer"></div>
        </div>
        <!-- FTD (Full Truck Dispatch) Report -->
        <div class="section-header">FTD (Full Truck Dispatch) Report</div>
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="ftdReportDate" class="form-label">Select Date for Report</label>
                <input type="date" class="form-control" id="ftdReportDate">
            </div>
            <div class="col-md-3">
                <label for="ftdReportShift" class="form-label">Select Shift</label>
                <select class="form-select" id="ftdReportShift">
                    <option value="A-SHIFT">A-SHIFT (Day)</option>
                    <option value="B-SHIFT">B-SHIFT (Night)</option>
                    <option value="ALL">FULL DAY</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-black form-control" id="btnFtdReport">Generate FTD Report</button>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <div id="selectedDateDisplay" style="font-weight: bold;"></div>
            </div>
        </div>
        <div class="report-actions" id="ftdReportActions" style="display: none;">
            <button type="button" class="btn btn-black" id="btnDownloadFtdPDF">Download PDF Report</button>
            <button type="button" class="btn btn-success" id="btnDownloadFtdExcel">Download Excel Report</button>
        </div>
        <div class="table-responsive">
            <div id="ftdReportContainer"></div>
        </div>
        <!-- Transport Bill Report -->
        <div class="section-header">Transport Bill Report</div>
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="transportBillDate" class="form-label">Select Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="transportBillStartDate">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="transportBillEndDate">
                </div>
            </div>
            <div class="col-md-3">
                <label for="transportBillVehicle" class="form-label">Vehicle No (Optional)</label>
                <input type="text" class="form-control" id="transportBillVehicle" placeholder="Leave blank for all vehicles">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btnTransportBill">Generate Transport Bill</button>
            </div>
        </div>
        <div class="report-actions" id="transportReportActions" style="display: none;">
            <button type="button" class="btn btn-success" id="btnDownloadTransportPDF">Download PDF Report</button>
            <button type="button" class="btn btn-primary" id="btnDownloadTransportExcel">Download Excel Report</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered report-table" id="transportBillTable">
                <thead>
                    <tr>
                        <th>Vehicle No</th>
                        <th>Total Trips</th>
                        <th>Total NET WT (MT)</th>
                        <th>Total Transport Amount</th>
                        <th>Transaction Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center">No report generated yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- Client Wise Dispatch Bill Report -->
        <div class="section-header">Client Wise Dispatch Bill Report</div>
        <div class="row mb-4">
            <div class="col-md-4">
                <label class="form-label">Select Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="clientBillStartDate">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="clientBillEndDate">
                </div>
            </div>
            <div class="col-md-3">
                <label for="clientBillClient" class="form-label">Client (Optional)</label>
                <input type="text" class="form-control" id="clientBillClient" placeholder="Leave blank for all clients">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btnClientBill">Generate Client Bill</button>
            </div>
        </div>
        <div class="report-actions" id="clientReportActions" style="display: none;">
            <button type="button" class="btn btn-success" id="btnDownloadClientPDF">Download PDF Report</button>
            <button type="button" class="btn btn-primary" id="btnDownloadClientExcel">Download Excel Report</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered report-table" id="clientBillTable">
                <thead>
                    <tr>
                        <th>Client Details</th>
                        <th>Total Trips</th>
                        <th>Total NET WT (MT)</th>
                        <th>Total Sale Amount</th>
                        <th>Transaction Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center">No report generated yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Add Vehicle Modal -->
    <div class="modal fade" id="addVehicleModal" tabindex="-1" aria-labelledby="addVehicleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addVehicleModalLabel">Add New Vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newVehicleNo" class="form-label">Vehicle Number</label>
                        <input type="text" class="form-control" id="newVehicleNo">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveVehicle">Save Vehicle</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Client Modal -->
    <div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClientModalLabel">Add New Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newClientName" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="newClientName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveClient">Save Client</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.jsPDF = window.jspdf.jsPDF;
        let allRecords = [];
        let recordIdCounter = 1;
        let vehicleNumbers = [
            "AP39UJ1166", "AP39UJ2399", "AP39UZ3659", "AP39VF1899", "AP39UJ5678",
            "AP39VF2339", "AP39W3579", "AP39WC2389", "AP39TV2537", "AP39VE2979",
            "AP39WD5679", "AP31TN2579", "AP39UJ2489", "AP39TV2536", "AP39WD8349",
            "AP39UY3345", "AP39UY3435", "AP39VC5289", "AP39WD4199", "AP39WC7449",
            "AP39UZ3335", "AP39UH2489", "AP31TN4302", "AP39VB8829", "AP39UU5665",
            "AP39VB2427", "AP39UD1589", "AP39UF3245", "AP39UG0559"
        ];
        let clientNames = [
            "L & T P1 – Rambali", "L & T P2 – Rambali", "KEC – Rambali", "JS Mining – Rambali",
            "ITD – Rambali", "Sowaparnika – Rambali", "L & T Jio – Sindhiya", "Arabind – Shela Nagar",
            "RKD – Shela Nagar", "Afcyan – Shela Ngr", "Bharath Verma – Airport", "Aparna RMC – Gajuwaka",
            "ACC RMC – Gajuwaka", "Prisam RMC – Gajuwaka", "Nuvoco RMC – Gajuwaka", "Ultratech – Mindi",
            "MK Builders – Madhurwada", "North Star Homes – Madhurwada", "Coastal RMC – Madhurwada",
            "Coastal RMC – Achututapuram", "Vizag Port – Vizag Port"
        ];
        let currentDispatchReportData = null;
        let currentFtdReportData = null;
        let currentTransportReportData = null;
        let currentClientReportData = null;
        
        // Load data from localStorage when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            
            // Initialize vehicle dropdown
            const vehicleDropdown = document.getElementById('vehicleDropdown');
            vehicleNumbers.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle;
                option.textContent = vehicle;
                vehicleDropdown.appendChild(option);
            });
            
            // Initialize client dropdown
            const clientDropdown = document.getElementById('clientDropdown');
            clientNames.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientDropdown.appendChild(option);
            });
            
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('accountingDate').value = today;
            document.getElementById('date').value = today;
            document.getElementById('dispatchReportDate').value = today;
            document.getElementById('ftdReportDate').value = today;
            document.getElementById('transportBillStartDate').value = today;
            document.getElementById('transportBillEndDate').value = today;
            document.getElementById('clientBillStartDate').value = today;
            document.getElementById('clientBillEndDate').value = today;
            
            // Event listeners for calculations
            document.getElementById('grossWt').addEventListener('input', calculateValues);
            document.getElementById('tareWt').addEventListener('input', calculateValues);
            document.getElementById('ratePerTone').addEventListener('input', calculateValues);
            document.getElementById('royaltyRate').addEventListener('input', calculateValues);
            document.getElementById('transportRate').addEventListener('input', calculateValues);
            document.getElementById('cashReceived').addEventListener('input', calculateValues);
            document.getElementById('advanceReceived').addEventListener('input', calculateValues);
            
            // Vehicle dropdown change event
            document.getElementById('vehicleDropdown').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('vehicleNo').value = this.value;
                }
            });
            
            // Client dropdown change event
            document.getElementById('clientDropdown').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('clientDetails').value = this.value;
                }
            });
            
            // Add new vehicle button
            document.getElementById('btnAddVehicle').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addVehicleModal'));
                modal.show();
            });
            
            // Save new vehicle
            document.getElementById('btnSaveVehicle').addEventListener('click', function() {
                const newVehicleNo = document.getElementById('newVehicleNo').value.trim().toUpperCase();
                if (newVehicleNo && !vehicleNumbers.includes(newVehicleNo)) {
                    vehicleNumbers.push(newVehicleNo);
                    const option = document.createElement('option');
                    option.value = newVehicleNo;
                    option.textContent = newVehicleNo;
                    vehicleDropdown.appendChild(option);
                    vehicleDropdown.value = newVehicleNo;
                    document.getElementById('vehicleNo').value = newVehicleNo;
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addVehicleModal'));
                    modal.hide();
                    document.getElementById('newVehicleNo').value = '';
                    
                    // Save updated vehicle list to localStorage
                    saveToLocalStorage('vehicleNumbers', vehicleNumbers);
                } else if (vehicleNumbers.includes(newVehicleNo)) {
                    alert("This vehicle number already exists in the list.");
                } else {
                    alert("Please enter a valid vehicle number.");
                }
            });
            
            // Add new client button
            document.getElementById('btnAddClient').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addClientModal'));
                modal.show();
            });
            
            // Save new client
            document.getElementById('btnSaveClient').addEventListener('click', function() {
                const newClientName = document.getElementById('newClientName').value.trim();
                if (newClientName && !clientNames.includes(newClientName)) {
                    clientNames.push(newClientName);
                    const option = document.createElement('option');
                    option.value = newClientName;
                    option.textContent = newClientName;
                    clientDropdown.appendChild(option);
                    clientDropdown.value = newClientName;
                    document.getElementById('clientDetails').value = newClientName;
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
                    modal.hide();
                    document.getElementById('newClientName').value = '';
                    
                    // Save updated client list to localStorage
                    saveToLocalStorage('clientNames', clientNames);
                } else if (clientNames.includes(newClientName)) {
                    alert("This client name already exists in the list.");
                } else {
                    alert("Please enter a valid client name.");
                }
            });
            
            // Report generation buttons
            document.getElementById('btnDispatchReport').addEventListener('click', generateDispatchReport);
            document.getElementById('btnFtdReport').addEventListener('click', generateFtdReport);
            document.getElementById('btnTransportBill').addEventListener('click', generateTransportBill);
            document.getElementById('btnClientBill').addEventListener('click', generateClientBill);
            
            // PDF download buttons
            document.getElementById('btnDownloadDispatchPDF').addEventListener('click', downloadDispatchPDF);
            document.getElementById('btnDownloadFtdPDF').addEventListener('click', downloadFtdPDF);
            document.getElementById('btnDownloadTransportPDF').addEventListener('click', downloadTransportPDF);
            document.getElementById('btnDownloadClientPDF').addEventListener('click', downloadClientPDF);
            
            // Excel download buttons
            document.getElementById('btnDownloadDispatchExcel').addEventListener('click', downloadDispatchExcel);
            document.getElementById('btnDownloadFtdExcel').addEventListener('click', downloadFtdExcel);
            document.getElementById('btnDownloadTransportExcel').addEventListener('click', downloadTransportExcel);
            document.getElementById('btnDownloadClientExcel').addEventListener('click', downloadClientExcel);
            
            // Form submission
            document.getElementById('weighmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addRecord();
            });
            
            // Export to Excel button
            document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);
            
            // Clear storage button
            document.getElementById('btnClearStorage').addEventListener('click', function() {
                if (confirm("Are you sure you want to clear all data? This action cannot be undone.")) {
                    clearLocalStorage();
                    alert("All data has been cleared.");
                }
            });
            
            // Update selected date display
            document.getElementById('ftdReportDate').addEventListener('change', function() {
                document.getElementById('selectedDateDisplay').textContent = formatDate(this.value);
            });
            
            // Initialize selected date display
            document.getElementById('selectedDateDisplay').textContent = formatDate(today);
        });
        
        // Local Storage Functions
        function saveToLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        function loadFromLocalStorage() {
            // Load records
            const storedRecords = localStorage.getItem('allRecords');
            if (storedRecords) {
                allRecords = JSON.parse(storedRecords);
                recordIdCounter = allRecords.length > 0 ? Math.max(...allRecords.map(r => r.id)) + 1 : 1;
                updateRecordsTable();
            }
            
            // Load vehicle numbers
            const storedVehicles = localStorage.getItem('vehicleNumbers');
            if (storedVehicles) {
                vehicleNumbers = JSON.parse(storedVehicles);
            }
            
            // Load client names
            const storedClients = localStorage.getItem('clientNames');
            if (storedClients) {
                clientNames = JSON.parse(storedClients);
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('allRecords');
            localStorage.removeItem('vehicleNumbers');
            localStorage.removeItem('clientNames');
            allRecords = [];
            recordIdCounter = 1;
            updateRecordsTable();
        }
        
        function calculateValues() {
            const grossWt = parseFloat(document.getElementById('grossWt').value) || 0;
            const tareWt = parseFloat(document.getElementById('tareWt').value) || 0;
            const netWt = grossWt - tareWt;
            document.getElementById('netWt').value = netWt.toFixed(2);
            
            const ratePerTone = parseFloat(document.getElementById('ratePerTone').value) || 0;
            const saleAmount = netWt * ratePerTone;
            document.getElementById('saleAmount').value = saleAmount.toFixed(2);
            
            const royaltyRate = parseFloat(document.getElementById('royaltyRate').value) || 0;
            const royaltyAmount = netWt * royaltyRate;
            document.getElementById('royaltyAmount').value = royaltyAmount.toFixed(2);
            
            const transportRate = parseFloat(document.getElementById('transportRate').value) || 0;
            const transportAmount = netWt * transportRate;
            document.getElementById('transportAmount').value = transportAmount.toFixed(2);
            
            const totalAmount = saleAmount + royaltyAmount + transportAmount;
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);
            
            const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
            const advanceReceived = parseFloat(document.getElementById('advanceReceived').value) || 0;
            const customerBalance = totalAmount - cashReceived - advanceReceived;
            document.getElementById('customerBalance').value = customerBalance.toFixed(2);
        }
        
        function addRecord() {
            calculateValues();
            
            const record = {
                id: recordIdCounter++,
                accountingDate: document.getElementById('accountingDate').value,
                date: document.getElementById('date').value,
                shift: document.getElementById('shift').value,
                weighmentSlipNo: document.getElementById('weighmentSlipNo').value,
                deliveryChallanNo: document.getElementById('deliveryChallanNo').value,
                royaltyPermitNo: document.getElementById('royaltyPermitNo').value,
                permitQty: parseFloat(document.getElementById('permitQty').value) || 0,
                royaltyRate: parseFloat(document.getElementById('royaltyRate').value) || 0,
                clientDetails: document.getElementById('clientDetails').value,
                paymentMode: document.getElementById('paymentMode').value,
                transportType: document.getElementById('transportType').value,
                vehicleNo: document.getElementById('vehicleNo').value,
                materialType: document.getElementById('materialType').value,
                transportRate: parseFloat(document.getElementById('transportRate').value) || 0,
                grossWt: parseFloat(document.getElementById('grossWt').value) || 0,
                tareWt: parseFloat(document.getElementById('tareWt').value) || 0,
                netWt: parseFloat(document.getElementById('netWt').value) || 0,
                ratePerTone: parseFloat(document.getElementById('ratePerTone').value) || 0,
                saleAmount: parseFloat(document.getElementById('saleAmount').value) || 0,
                cashReceived: parseFloat(document.getElementById('cashReceived').value) || 0,
                advanceReceived: parseFloat(document.getElementById('advanceReceived').value) || 0,
                customerBalance: parseFloat(document.getElementById('customerBalance').value) || 0,
                royaltyAmount: parseFloat(document.getElementById('royaltyAmount').value) || 0,
                transportAmount: parseFloat(document.getElementById('transportAmount').value) || 0,
                totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                remarks: document.getElementById('remarks').value
            };
            
            allRecords.push(record);
            
            // Save to localStorage
            saveToLocalStorage('allRecords', allRecords);
            
            updateRecordsTable();
            document.getElementById('weighmentForm').reset();
            
            // Set default dates to today again
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('accountingDate').value = today;
            document.getElementById('date').value = today;
            
            // Set transport type to default value
            document.getElementById('transportType').value = "SGX Transport";
            
            alert("Record added successfully!");
        }
        
        function updateRecordsTable() {
            const tableBody = document.getElementById('recordsTable');
            tableBody.innerHTML = '';
            
            if (allRecords.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell(0);
                cell.textContent = 'No records found';
                cell.colSpan = 28;
                cell.className = 'text-center';
                return;
            }
            
            allRecords.forEach((record, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = record.accountingDate;
                row.insertCell(2).textContent = record.date;
                row.insertCell(3).textContent = record.shift;
                row.insertCell(4).textContent = record.weighmentSlipNo;
                row.insertCell(5).textContent = record.deliveryChallanNo;
                row.insertCell(6).textContent = record.royaltyPermitNo;
                row.insertCell(7).textContent = record.permitQty.toFixed(2);
                row.insertCell(8).textContent = record.clientDetails;
                row.insertCell(9).textContent = record.paymentMode;
                row.insertCell(10).textContent = record.transportType;
                row.insertCell(11).textContent = record.vehicleNo;
                row.insertCell(12).textContent = record.materialType;
                row.insertCell(13).textContent = record.grossWt.toFixed(2);
                row.insertCell(14).textContent = record.tareWt.toFixed(2);
                row.insertCell(15).textContent = record.netWt.toFixed(2);
                row.insertCell(16).textContent = record.ratePerTone.toFixed(2);
                row.insertCell(17).textContent = record.saleAmount.toFixed(2);
                row.insertCell(18).textContent = record.cashReceived.toFixed(2);
                row.insertCell(19).textContent = record.advanceReceived.toFixed(2);
                row.insertCell(20).textContent = record.customerBalance.toFixed(2);
                row.insertCell(21).textContent = record.remarks;
                row.insertCell(22).textContent = record.royaltyRate.toFixed(2);
                row.insertCell(23).textContent = record.royaltyAmount.toFixed(2);
                row.insertCell(24).textContent = record.transportRate.toFixed(2);
                row.insertCell(25).textContent = record.transportAmount.toFixed(2);
                row.insertCell(26).textContent = record.totalAmount.toFixed(2);
                
                const actionsCell = row.insertCell(27);
                actionsCell.innerHTML = '<button class="btn btn-sm btn-info me-1">View</button><button class="btn btn-sm btn-danger">Delete</button>';
                actionsCell.querySelector('.btn-danger').addEventListener('click', function() {
                    allRecords = allRecords.filter(r => r.id !== record.id);
                    
                    // Update localStorage after deletion
                    saveToLocalStorage('allRecords', allRecords);
                    
                    updateRecordsTable();
                });
            });
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function getMonthYear(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
        }
        
        function generateDispatchReport() {
            const reportDate = document.getElementById('dispatchReportDate').value;
            const reportShift = document.getElementById('dispatchReportShift').value;
            
            if (!reportDate) {
                alert("Please select a date for the report.");
                return;
            }
            
            let dateRecords = reportShift === "ALL" ?
                allRecords.filter(record => record.date === reportDate) :
                allRecords.filter(record => record.date === reportDate && record.shift === reportShift);
            
            if (dateRecords.length === 0) {
                alert("No records found for the selected criteria.");
                document.getElementById('dispatchReportActions').style.display = 'none';
                return;
            }
            
            const customerData = {};
            const materialTypes = ["10 MM", "20 MM", "V/SAND", "Scalping", "P/Sand", "40MM", "GSB/WET MIX", "R/Sand"];
            
            dateRecords.forEach(record => {
                if (!customerData[record.clientDetails]) {
                    customerData[record.clientDetails] = {
                        totalTonnage: 0,
                        totalTrips: 0,
                        materials: {}
                    };
                    materialTypes.forEach(material => {
                        customerData[record.clientDetails].materials[material] = { tonnage: 0, trips: 0 };
                    });
                }
                
                customerData[record.clientDetails].totalTonnage += record.netWt;
                customerData[record.clientDetails].totalTrips += 1;
                
                if (customerData[record.clientDetails].materials[record.materialType]) {
                    customerData[record.clientDetails].materials[record.materialType].tonnage += record.netWt;
                    customerData[record.clientDetails].materials[record.materialType].trips += 1;
                }
            });
            
            currentDispatchReportData = { date: reportDate, shift: reportShift, customerData, materialTypes };
            document.getElementById('dispatchReportActions').style.display = 'block';
            
            let reportHTML = '<table class="table table-bordered">';
            const formattedDate = formatDate(reportDate);
            reportHTML += `<tr class="shift-header"><th colspan="${materialTypes.length + 3}">${reportShift === "ALL" ? "FULL DAY" : reportShift} - Dispatch Vehicle Wise Planning - ${formattedDate}</th></tr>`;
            reportHTML += '<tr class="customer-header"><th>Client Details</th><th>Unit</th>';
            materialTypes.forEach(material => reportHTML += `<th>${material}</th>`);
            reportHTML += '<th>TOTAL</th></tr>';
            
            let grandTotalTonnage = 0, grandTotalTrips = 0;
            const materialTotals = {};
            materialTypes.forEach(material => materialTotals[material] = { tonnage: 0, trips: 0 });
            
            for (const customer in customerData) {
                reportHTML += `<tr><td rowspan="2" style="background-color: #d8bfd8; font-weight: bold;">${customer}</td><td>Total Tonnage (MT)</td>`;
                materialTypes.forEach(material => {
                    const tonnage = customerData[customer].materials[material].tonnage;
                    reportHTML += `<td class="number-cell">${tonnage > 0 ? tonnage.toFixed(2) : ''}</td>`;
                    materialTotals[material].tonnage += tonnage;
                });
                reportHTML += `<td class="number-cell">${customerData[customer].totalTonnage.toFixed(2)}</td></tr>`;
                
                reportHTML += `<tr><td>Total Trips</td>`;
                materialTypes.forEach(material => {
                    const trips = customerData[customer].materials[material].trips;
                    reportHTML += `<td class="number-cell">${trips > 0 ? trips : ''}</td>`;
                    materialTotals[material].trips += trips;
                });
                reportHTML += `<td class="number-cell">${customerData[customer].totalTrips}</td></tr>`;
                
                grandTotalTonnage += customerData[customer].totalTonnage;
                grandTotalTrips += customerData[customer].totalTrips;
            }
            
            reportHTML += `<tr class="total-header"><td colspan="2">GRAND TOTAL</td>`;
            materialTypes.forEach(material => {
                reportHTML += `<td class="number-cell">${materialTotals[material].tonnage > 0 ? materialTotals[material].tonnage.toFixed(2) : ''}</td>`;
            });
            reportHTML += `<td class="number-cell">${grandTotalTonnage.toFixed(2)}</td></tr>`;
            
            reportHTML += `<tr class="total-header"><td colspan="2">TOTAL TRIPS</td>`;
            materialTypes.forEach(material => {
                reportHTML += `<td class="number-cell">${materialTotals[material].trips > 0 ? materialTotals[material].trips : ''}</td>`;
            });
            reportHTML += `<td class="number-cell">${grandTotalTrips}</td></tr>`;
            
            reportHTML += '</table>';
            document.getElementById('dispatchReportContainer').innerHTML = reportHTML;
        }
        
        function generateFtdReport() {
            const reportDate = document.getElementById('ftdReportDate').value;
            const reportShift = document.getElementById('ftdReportShift').value;
            
            if (!reportDate) {
                alert("Please select a date for the report.");
                return;
            }
            
            // Get records for the selected date
            let dateRecords = allRecords.filter(record => record.date === reportDate);
            
            if (dateRecords.length === 0) {
                alert("No records found for the selected criteria.");
                document.getElementById('ftdReportActions').style.display = 'none';
                return;
            }
            
            // Separate day and night shifts
            const dayRecords = dateRecords.filter(record => record.shift === "A-SHIFT");
            const nightRecords = dateRecords.filter(record => record.shift === "B-SHIFT");
            
            const materialTypes = ["10 MM", "20 MM", "V/SAND", "Scalping", "P/Sand", "40MM", "GSB/WET MIX", "R/Sand"];
            
            // Build dayCustomerData
            const dayCustomerData = {};
            dayRecords.forEach(record => {
                if (!dayCustomerData[record.clientDetails]) {
                    dayCustomerData[record.clientDetails] = {
                        totalTonnage: 0,
                        totalTrips: 0,
                        materials: {},
                        transactions: []
                    };
                    materialTypes.forEach(material => {
                        dayCustomerData[record.clientDetails].materials[material] = { tonnage: 0, trips: 0 };
                    });
                }
                
                dayCustomerData[record.clientDetails].totalTonnage += record.netWt;
                dayCustomerData[record.clientDetails].totalTrips += 1;
                
                if (dayCustomerData[record.clientDetails].materials[record.materialType]) {
                    dayCustomerData[record.clientDetails].materials[record.materialType].tonnage += record.netWt;
                    dayCustomerData[record.clientDetails].materials[record.materialType].trips += 1;
                }
                
                dayCustomerData[record.clientDetails].transactions.push({
                    date: record.date,
                    client: record.clientDetails,
                    material: record.materialType,
                    netWt: record.netWt,
                    rate: record.ratePerTone,
                    amount: record.saleAmount
                });
            });
            
            // Build nightCustomerData
            const nightCustomerData = {};
            nightRecords.forEach(record => {
                if (!nightCustomerData[record.clientDetails]) {
                    nightCustomerData[record.clientDetails] = {
                        totalTonnage: 0,
                        totalTrips: 0,
                        materials: {},
                        transactions: []
                    };
                    materialTypes.forEach(material => {
                        nightCustomerData[record.clientDetails].materials[material] = { tonnage: 0, trips: 0 };
                    });
                }
                
                nightCustomerData[record.clientDetails].totalTonnage += record.netWt;
                nightCustomerData[record.clientDetails].totalTrips += 1;
                
                if (nightCustomerData[record.clientDetails].materials[record.materialType]) {
                    nightCustomerData[record.clientDetails].materials[record.materialType].tonnage += record.netWt;
                    nightCustomerData[record.clientDetails].materials[record.materialType].trips += 1;
                }
                
                nightCustomerData[record.clientDetails].transactions.push({
                    date: record.date,
                    client: record.clientDetails,
                    material: record.materialType,
                    netWt: record.netWt,
                    rate: record.ratePerTone,
                    amount: record.saleAmount
                });
            });
            
            currentFtdReportData = { 
                date: reportDate, 
                shift: reportShift, 
                materialTypes,
                dayRecords,
                nightRecords,
                dayCustomerData,
                nightCustomerData
            };
            document.getElementById('ftdReportActions').style.display = 'block';
            
            let reportHTML = '';
            const formattedDate = formatDate(reportDate);
            
            // Calculate totals for day and night shifts
            let dayTotalTonnage = 0;
            let dayTotalTrips = 0;
            const dayMaterialTotals = {};
            materialTypes.forEach(material => dayMaterialTotals[material] = { tonnage: 0, trips: 0 });
            
            dayRecords.forEach(record => {
                dayTotalTonnage += record.netWt;
                dayTotalTrips += 1;
                if (dayMaterialTotals[record.materialType]) {
                    dayMaterialTotals[record.materialType].tonnage += record.netWt;
                    dayMaterialTotals[record.materialType].trips += 1;
                }
            });
            
            let nightTotalTonnage = 0;
            let nightTotalTrips = 0;
            const nightMaterialTotals = {};
            materialTypes.forEach(material => nightMaterialTotals[material] = { tonnage: 0, trips: 0 });
            
            nightRecords.forEach(record => {
                nightTotalTonnage += record.netWt;
                nightTotalTrips += 1;
                if (nightMaterialTotals[record.materialType]) {
                    nightMaterialTotals[record.materialType].tonnage += record.netWt;
                    nightMaterialTotals[record.materialType].trips += 1;
                }
            });
            
            // Calculate combined totals
            const combinedTotalTonnage = dayTotalTonnage + nightTotalTonnage;
            const combinedTotalTrips = dayTotalTrips + nightTotalTrips;
            const combinedMaterialTotals = {};
            materialTypes.forEach(material => {
                combinedMaterialTotals[material] = {
                    tonnage: (dayMaterialTotals[material]?.tonnage || 0) + (nightMaterialTotals[material]?.tonnage || 0),
                    trips: (dayMaterialTotals[material]?.trips || 0) + (nightMaterialTotals[material]?.trips || 0)
                };
            });
            
            // Calculate cash and credit sales
            let totalCashSale = 0;
            let totalCreditSale = 0;
            
            const filteredRecords = reportShift === "ALL" ? dateRecords : reportShift === "A-SHIFT" ? dayRecords : nightRecords;
            filteredRecords.forEach(record => {
                if (record.paymentMode === "Cash") {
                    totalCashSale += record.saleAmount;
                } else if (record.paymentMode === "Credit") {
                    totalCreditSale += record.saleAmount;
                }
            });
            
            // Generate report based on selected shift
            if (reportShift === "A-SHIFT" || reportShift === "ALL") {
                reportHTML += `<div class="section-header">A-SHIFT (Day Shift) – Dispatch Vehicle Wise Planning</div>`;
                reportHTML += `<table class="ftd-report-table">`;
                reportHTML += `<thead><tr><th>Customer Name</th>`;
                materialTypes.forEach(material => reportHTML += `<th>${material}</th>`);
                reportHTML += `<th>TOTAL</th></tr></thead><tbody>`;
                
                // Add day shift customer data
                for (const customer in dayCustomerData) {
                    reportHTML += `<tr class="ftd-customer-row"><td>${customer}</td>`;
                    materialTypes.forEach(material => {
                        const tonnage = dayCustomerData[customer].materials[material].tonnage;
                        reportHTML += `<td>${tonnage > 0 ? tonnage.toFixed(2) : ''}</td>`;
                    });
                    reportHTML += `<td>${dayCustomerData[customer].totalTonnage.toFixed(2)}</td></tr>`;
                }
                
                // Add day shift totals if not ALL
                if (reportShift === "A-SHIFT") {
                    reportHTML += `<tr class="ftd-total-row"><td>Total No of Vehicles: ${dayTotalTrips}</td>`;
                    materialTypes.forEach(material => {
                        reportHTML += `<td>${dayMaterialTotals[material]?.tonnage > 0 ? dayMaterialTotals[material].tonnage.toFixed(2) : ''}</td>`;
                    });
                    reportHTML += `<td>${dayTotalTonnage.toFixed(2)}</td></tr>`;
                }
                reportHTML += `</tbody></table>`;
            }
            
            if (reportShift === "B-SHIFT" || reportShift === "ALL") {
                reportHTML += `<div class="section-header">B-SHIFT (Night Shift) – Dispatch Vehicle Wise Planning</div>`;
                reportHTML += `<table class="ftd-report-table">`;
                reportHTML += `<thead><tr><th>Customer Name</th>`;
                materialTypes.forEach(material => reportHTML += `<th>${material}</th>`);
                reportHTML += `<th>TOTAL</th></tr></thead><tbody>`;
                
                // Add night shift customer data
                for (const customer in nightCustomerData) {
                    reportHTML += `<tr class="ftd-customer-row"><td>${customer}</td>`;
                    materialTypes.forEach(material => {
                        const tonnage = nightCustomerData[customer].materials[material].tonnage;
                        reportHTML += `<td>${tonnage > 0 ? tonnage.toFixed(2) : ''}</td>`;
                    });
                    reportHTML += `<td>${nightCustomerData[customer].totalTonnage.toFixed(2)}</td></tr>`;
                }
                
                // Add night shift totals if not ALL
                if (reportShift === "B-SHIFT") {
                    reportHTML += `<tr class="ftd-total-row"><td>Total No of Vehicles: ${nightTotalTrips}</td>`;
                    materialTypes.forEach(material => {
                        reportHTML += `<td>${nightMaterialTotals[material]?.tonnage > 0 ? nightMaterialTotals[material].tonnage.toFixed(2) : ''}</td>`;
                    });
                    reportHTML += `<td>${nightTotalTonnage.toFixed(2)}</td></tr>`;
                }
                reportHTML += `</tbody></table>`;
            }
            
            // Add summary table for FULL DAY report
            if (reportShift === "ALL") {
                reportHTML += `<div class="section-header">Summary</div>`;
                reportHTML += `<table class="ftd-summary-table">`;
                reportHTML += `<thead><tr><th>Shift</th><th>No of Vehicles</th>`;
                materialTypes.forEach(material => reportHTML += `<th>${material}</th>`);
                reportHTML += `<th>Grand Total MT</th></tr></thead><tbody>`;
                
                // Day shift summary
                reportHTML += `<tr><td>Day Shift Total</td><td>${dayTotalTrips}</td>`;
                materialTypes.forEach(material => {
                    reportHTML += `<td>${dayMaterialTotals[material]?.tonnage > 0 ? dayMaterialTotals[material].tonnage.toFixed(2) : ''}</td>`;
                });
                reportHTML += `<td>${dayTotalTonnage.toFixed(2)}</td></tr>`;
                
                // Night shift summary
                reportHTML += `<tr><td>Night Shift Total</td><td>${nightTotalTrips}</td>`;
                materialTypes.forEach(material => {
                    reportHTML += `<td>${nightMaterialTotals[material]?.tonnage > 0 ? nightMaterialTotals[material].tonnage.toFixed(2) : ''}</td>`;
                });
                reportHTML += `<td>${nightTotalTonnage.toFixed(2)}</td></tr>`;
                
                // Combined totals
                reportHTML += `<tr class="ftd-summary-total"><td>Combined Total (Day + Night)</td><td>${combinedTotalTrips}</td>`;
                materialTypes.forEach(material => {
                    reportHTML += `<td>${combinedMaterialTotals[material]?.tonnage > 0 ? combinedMaterialTotals[material].tonnage.toFixed(2) : ''}</td>`;
                });
                reportHTML += `<td>${combinedTotalTonnage.toFixed(2)}</td></tr>`;
                
                // Overall grand total
                reportHTML += `<tr class="ftd-summary-total"><td colspan="2">Overall Grand Total Vehicles: ${combinedTotalTrips}</td>`;
                reportHTML += `<td colspan="${materialTypes.length}">Overall Grand Total MT: ${combinedTotalTonnage.toFixed(2)}</td>`;
                reportHTML += `<td></td></tr>`;
                
                // Cash and credit sales
                reportHTML += `<tr class="ftd-summary-total"><td colspan="2">Total Cash Sale Amount: ₹${totalCashSale.toFixed(2)}</td>`;
                reportHTML += `<td colspan="${materialTypes.length}">Total Credit Sale Amount: ₹${totalCreditSale.toFixed(2)}</td>`;
                reportHTML += `<td></td></tr>`;
                
                reportHTML += `</tbody></table>`;
            }
            
            // Add transaction details in point format (without slip numbers)
            reportHTML += `<div class="section-header">Transaction Details</div>`;
            reportHTML += `<div class="transaction-details">`;
            
            let allTransactions = [];
            if (reportShift === "A-SHIFT" || reportShift === "ALL") {
                Object.values(dayCustomerData).forEach(cust => allTransactions.push(...cust.transactions));
            }
            if (reportShift === "B-SHIFT" || reportShift === "ALL") {
                Object.values(nightCustomerData).forEach(cust => allTransactions.push(...cust.transactions));
            }
            
            let transactionCounter = 1;
            reportHTML += `<div class="transaction-points">`;
            allTransactions.forEach(tx => {
                reportHTML += `<div class="transaction-point">`;
                reportHTML += `${transactionCounter++}. Date: ${formatDate(tx.date)}, Client: ${tx.client}, Material: ${tx.material}, Net WT: ${tx.netWt.toFixed(2)} MT, Rate: ${tx.rate.toFixed(2)}, Amount: ${tx.amount.toFixed(2)}`;
                reportHTML += `</div>`;
            });
            reportHTML += `</div>`;
            
            reportHTML += `</div>`;
            
            document.getElementById('ftdReportContainer').innerHTML = reportHTML;
        }

        function generateTransportBill() {
            const startDate = document.getElementById('transportBillStartDate').value;
            const endDate = document.getElementById('transportBillEndDate').value;
            const vehicleNo = document.getElementById('transportBillVehicle').value.trim();
            
            if (!startDate || !endDate) {
                alert("Please select a date range for the report.");
                return;
            }
            
            let dateRecords = allRecords.filter(record => record.date >= startDate && record.date <= endDate);
            if (vehicleNo) {
                dateRecords = dateRecords.filter(record => record.vehicleNo === vehicleNo);
            }
            
            if (dateRecords.length === 0) {
                alert("No records found for the selected criteria.");
                document.getElementById('transportReportActions').style.display = 'none';
                return;
            }
            
            const vehicleData = {};
            
            dateRecords.forEach(record => {
                if (!vehicleData[record.vehicleNo]) {
                    vehicleData[record.vehicleNo] = {
                        totalTrips: 0,
                        totalNetWt: 0,
                        totalTransportAmount: 0,
                        transactions: []
                    };
                }
                
                vehicleData[record.vehicleNo].totalTrips += 1;
                vehicleData[record.vehicleNo].totalNetWt += record.netWt;
                vehicleData[record.vehicleNo].totalTransportAmount += record.transportAmount;
                vehicleData[record.vehicleNo].transactions.push({
                    weighmentSlipNo: record.weighmentSlipNo,
                    clientDetails: record.clientDetails,
                    materialType: record.materialType,
                    netWt: record.netWt,
                    transportAmount: record.transportAmount,
                    date: record.date
                });
            });
            
            currentTransportReportData = { startDate, endDate, vehicleNo, vehicleData };
            document.getElementById('transportReportActions').style.display = 'block';
            
            const tableBody = document.getElementById('transportBillTable').querySelector('tbody');
            tableBody.innerHTML = '';
            
            for (const vehicle in vehicleData) {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = vehicle;
                row.insertCell(1).textContent = vehicleData[vehicle].totalTrips;
                row.insertCell(2).textContent = vehicleData[vehicle].totalNetWt.toFixed(2);
                row.insertCell(3).textContent = vehicleData[vehicle].totalTransportAmount.toFixed(2);
                
                const detailsCell = row.insertCell(4);
                detailsCell.className = 'transaction-details';
                
                let transactionCounter = 1;
                vehicleData[vehicle].transactions.forEach(tx => {
                    detailsCell.innerHTML += `<div class="transaction-row">${transactionCounter++}. Slip No: ${tx.weighmentSlipNo}, Client: ${tx.clientDetails}, Material: ${tx.materialType}, Net WT: ${tx.netWt.toFixed(2)}, Transport Amount: ${tx.transportAmount.toFixed(2)}</div>`;
                });
            }
        }

        function generateClientBill() {
            const startDate = document.getElementById('clientBillStartDate').value;
            const endDate = document.getElementById('clientBillEndDate').value;
            const clientDetails = document.getElementById('clientBillClient').value.trim();
            
            if (!startDate || !endDate) {
                alert("Please select a date range for the report.");
                return;
            }
            
            let dateRecords = allRecords.filter(record => record.date >= startDate && record.date <= endDate);
            if (clientDetails) {
                dateRecords = dateRecords.filter(record => record.clientDetails === clientDetails);
            }
            
            if (dateRecords.length === 0) {
                alert("No records found for the selected criteria.");
                document.getElementById('clientReportActions').style.display = 'none';
                return;
            }
            
            const clientData = {};
            
            dateRecords.forEach(record => {
                if (!clientData[record.clientDetails]) {
                    clientData[record.clientDetails] = {
                        totalTrips: 0,
                        totalNetWt: 0,
                        totalSaleAmount: 0,
                        transactions: []
                    };
                }
                
                clientData[record.clientDetails].totalTrips += 1;
                clientData[record.clientDetails].totalNetWt += record.netWt;
                clientData[record.clientDetails].totalSaleAmount += record.saleAmount;
                clientData[record.clientDetails].transactions.push({
                    date: record.date,
                    weighmentSlipNo: record.weighmentSlipNo,
                    materialType: record.materialType,
                    netWt: record.netWt,
                    ratePerTone: record.ratePerTone,
                    saleAmount: record.saleAmount,
                    vehicleNo: record.vehicleNo
                });
            });
            
            currentClientReportData = { startDate, endDate, clientDetails, clientData };
            document.getElementById('clientReportActions').style.display = 'block';
            
            const tableBody = document.getElementById('clientBillTable').querySelector('tbody');
            tableBody.innerHTML = '';
            
            for (const client in clientData) {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = client;
                row.insertCell(1).textContent = clientData[client].totalTrips;
                row.insertCell(2).textContent = clientData[client].totalNetWt.toFixed(2);
                row.insertCell(3).textContent = clientData[client].totalSaleAmount.toFixed(2);
                
                const detailsCell = row.insertCell(4);
                detailsCell.className = 'transaction-details';
                
                // Sort transactions by date
                clientData[client].transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                let currentMonth = '';
                let monthTrips = 0;
                let monthNetWt = 0;
                let monthSaleAmount = 0;
                let transactionCounter = 1;
                
                clientData[client].transactions.forEach(tx => {
                    const monthYear = getMonthYear(tx.date);
                    if (monthYear !== currentMonth) {
                        if (currentMonth) {
                            // Add month total
                            detailsCell.innerHTML += `<div class="month-total transaction-row">Month Total: Trips: ${monthTrips}, Net WT: ${monthNetWt.toFixed(2)}, Sale Amount: ${monthSaleAmount.toFixed(2)}</div>`;
                        }
                        detailsCell.innerHTML += `<div class="month-header">${monthYear}</div>`;
                        currentMonth = monthYear;
                        monthTrips = 0;
                        monthNetWt = 0;
                        monthSaleAmount = 0;
                    }
                    
                    detailsCell.innerHTML += `<div class="transaction-row vehicle-row">${transactionCounter++}. Date: ${formatDate(tx.date)}, Slip No: ${tx.weighmentSlipNo}, Material: ${tx.materialType}, Net WT: ${tx.netWt.toFixed(2)}, Rate: ${tx.ratePerTone.toFixed(2)}, Amount: ${tx.saleAmount.toFixed(2)}, Vehicle: ${tx.vehicleNo}</div>`;
                    
                    monthTrips += 1;
                    monthNetWt += tx.netWt;
                    monthSaleAmount += tx.saleAmount;
                });
                
                // Add last month total
                if (currentMonth) {
                    detailsCell.innerHTML += `<div class="month-total transaction-row">Month Total: Trips: ${monthTrips}, Net WT: ${monthNetWt.toFixed(2)}, Sale Amount: ${monthSaleAmount.toFixed(2)}</div>`;
                }
                
                // Add grand total
                detailsCell.innerHTML += `<div class="grand-total transaction-row">Grand Total: Trips: ${clientData[client].totalTrips}, Net WT: ${clientData[client].totalNetWt.toFixed(2)}, Sale Amount: ${clientData[client].totalSaleAmount.toFixed(2)}</div>`;
            }
        }
        
        function downloadDispatchPDF() {
            if (!currentDispatchReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { date, shift, customerData, materialTypes } = currentDispatchReportData;
            
            doc.setFontSize(14);
            doc.text(`${shift === "ALL" ? "FULL DAY" : shift} - Dispatch Vehicle Wise Planning - ${formatDate(date)}`, 14, 20);
            
            const tableData = [];
            
            for (const customer in customerData) {
                const tonnageRow = [customer, 'Total Tonnage (MT)'];
                const tripsRow = ['', 'Total Trips'];
                
                materialTypes.forEach(material => {
                    const tonnage = customerData[customer].materials[material].tonnage;
                    const trips = customerData[customer].materials[material].trips;
                    tonnageRow.push(tonnage > 0 ? tonnage.toFixed(2) : '');
                    tripsRow.push(trips > 0 ? trips : '');
                });
                
                tonnageRow.push(customerData[customer].totalTonnage.toFixed(2));
                tripsRow.push(customerData[customer].totalTrips);
                tableData.push(tonnageRow, tripsRow);
            }
            
            const totalTonnageRow = ['GRAND TOTAL', 'Total Tonnage (MT)'];
            const totalTripsRow = ['', 'Total Trips'];
            
            const materialTotals = {};
            materialTypes.forEach(material => materialTotals[material] = { tonnage: 0, trips: 0 });
            
            let grandTotalTonnage = 0, grandTotalTrips = 0;
            for (const customer in customerData) {
                materialTypes.forEach(material => {
                    materialTotals[material].tonnage += customerData[customer].materials[material].tonnage;
                    materialTotals[material].trips += customerData[customer].materials[material].trips;
                });
                grandTotalTonnage += customerData[customer].totalTonnage;
                grandTotalTrips += customerData[customer].totalTrips;
            }
            
            materialTypes.forEach(material => {
                totalTonnageRow.push(materialTotals[material].tonnage > 0 ? materialTotals[material].tonnage.toFixed(2) : '');
                totalTripsRow.push(materialTotals[material].trips > 0 ? materialTotals[material].trips : '');
            });
            
            totalTonnageRow.push(grandTotalTonnage.toFixed(2));
            totalTripsRow.push(grandTotalTrips);
            tableData.push(totalTonnageRow, totalTripsRow);
            
            doc.autoTable({
                head: [['Client Details', 'Unit', ...materialTypes, 'TOTAL']],
                body: tableData,
                startY: 30,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [44, 62, 80] },
                alternateRowStyles: { fillColor: [240, 240, 240] }
            });
            
            doc.save(`Dispatch_Report_${date}_${shift}.pdf`);
        }
        
        function downloadFtdPDF() {
            if (!currentFtdReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { date, shift, materialTypes, dayCustomerData, nightCustomerData } = currentFtdReportData;
            
            doc.setFontSize(14);
            doc.text(`FTD Report - ${shift} - ${formatDate(date)}`, 14, 20);
            
            let currentY = 30;
            
            // Add day shift if applicable
            if (shift === "A-SHIFT" || shift === "ALL") {
                doc.text("A-SHIFT (Day Shift) – Dispatch Vehicle Wise Planning", 14, currentY);
                currentY += 10;
                
                const dayTableData = [];
                for (const customer in dayCustomerData) {
                    const row = [customer];
                    materialTypes.forEach(material => {
                        row.push(dayCustomerData[customer].materials[material].tonnage > 0 ? dayCustomerData[customer].materials[material].tonnage.toFixed(2) : '');
                    });
                    row.push(dayCustomerData[customer].totalTonnage.toFixed(2));
                    dayTableData.push(row);
                }
                
                doc.autoTable({
                    head: [['Customer Name', ...materialTypes, 'TOTAL']],
                    body: dayTableData,
                    startY: currentY,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] },
                    alternateRowStyles: { fillColor: [240, 240, 240] }
                });
                currentY = doc.lastAutoTable.finalY + 20;
            }
            
            // Add night shift if applicable
            if (shift === "B-SHIFT" || shift === "ALL") {
                if (currentY > 30 && shift === "ALL") {
                    doc.addPage();
                    currentY = 20;
                }
                doc.text("B-SHIFT (Night Shift) – Dispatch Vehicle Wise Planning", 14, currentY);
                currentY += 10;
                
                const nightTableData = [];
                for (const customer in nightCustomerData) {
                    const row = [customer];
                    materialTypes.forEach(material => {
                        row.push(nightCustomerData[customer].materials[material].tonnage > 0 ? nightCustomerData[customer].materials[material].tonnage.toFixed(2) : '');
                    });
                    row.push(nightCustomerData[customer].totalTonnage.toFixed(2));
                    nightTableData.push(row);
                }
                
                doc.autoTable({
                    head: [['Customer Name', ...materialTypes, 'TOTAL']],
                    body: nightTableData,
                    startY: currentY,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [44, 62, 80] },
                    alternateRowStyles: { fillColor: [240, 240, 240] }
                });
            }
            
            doc.save(`FTD_Report_${date}_${shift}.pdf`);
        }
        
        function downloadTransportPDF() {
            if (!currentTransportReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { startDate, endDate, vehicleNo, vehicleData } = currentTransportReportData;
            
            doc.setFontSize(14);
            doc.text(`Transport Bill Report - ${formatDate(startDate)} to ${formatDate(endDate)}${vehicleNo ? ` - Vehicle: ${vehicleNo}` : ''}`, 14, 20);
            
            const tableData = [];
            
            for (const vehicle in vehicleData) {
                const transactions = vehicleData[vehicle].transactions.map(tx =>
                    `Slip No: ${tx.weighmentSlipNo}, Client: ${tx.clientDetails}, Material: ${tx.materialType}, Net WT: ${tx.netWt.toFixed(2)}, Transport Amount: ${tx.transportAmount.toFixed(2)}`
                ).join('\n');
                
                tableData.push([vehicle, vehicleData[vehicle].totalTrips, vehicleData[vehicle].totalNetWt.toFixed(2), vehicleData[vehicle].totalTransportAmount.toFixed(2), transactions]);
            }
            
            doc.autoTable({
                head: [['Vehicle No', 'Total Trips', 'Total NET WT (MT)', 'Total Transport Amount', 'Transaction Details']],
                body: tableData,
                startY: 30,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [44, 62, 80] },
                alternateRowStyles: { fillColor: [240, 240, 240] }
            });
            
            doc.save(`Transport_Bill_${startDate}_to_${endDate}${vehicleNo ? `_${vehicleNo}` : ''}.pdf`);
        }

        function downloadClientPDF() {
            if (!currentClientReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { startDate, endDate, clientDetails, clientData } = currentClientReportData;
            
            doc.setFontSize(14);
            doc.text(`Client Wise Dispatch Bill Report - ${formatDate(startDate)} to ${formatDate(endDate)}${clientDetails ? ` - Client: ${clientDetails}` : ''}`, 14, 20);
            
            const tableData = [];
            
            for (const client in clientData) {
                let transactionsStr = '';
                clientData[client].transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                let currentMonth = '';
                let monthTrips = 0;
                let monthNetWt = 0;
                let monthSaleAmount = 0;
                let transactionCounter = 1;
                
                clientData[client].transactions.forEach(tx => {
                    const monthYear = getMonthYear(tx.date);
                    if (monthYear !== currentMonth) {
                        if (currentMonth) {
                            transactionsStr += `Month Total: Trips: ${monthTrips}, Net WT: ${monthNetWt.toFixed(2)}, Sale Amount: ${monthSaleAmount.toFixed(2)}\n`;
                        }
                        transactionsStr += `${monthYear}\n`;
                        currentMonth = monthYear;
                        monthTrips = 0;
                        monthNetWt = 0;
                        monthSaleAmount = 0;
                    }
                    
                    transactionsStr += `${transactionCounter++}. Date: ${formatDate(tx.date)}, Slip No: ${tx.weighmentSlipNo}, Material: ${tx.materialType}, Net WT: ${tx.netWt.toFixed(2)}, Rate: ${tx.ratePerTone.toFixed(2)}, Amount: ${tx.saleAmount.toFixed(2)}, Vehicle: ${tx.vehicleNo}\n`;
                    
                    monthTrips += 1;
                    monthNetWt += tx.netWt;
                    monthSaleAmount += tx.saleAmount;
                });
                
                if (currentMonth) {
                    transactionsStr += `Month Total: Trips: ${monthTrips}, Net WT: ${monthNetWt.toFixed(2)}, Sale Amount: ${monthSaleAmount.toFixed(2)}\n`;
                }
                
                transactionsStr += `Grand Total: Trips: ${clientData[client].totalTrips}, Net WT: ${clientData[client].totalNetWt.toFixed(2)}, Sale Amount: ${clientData[client].totalSaleAmount.toFixed(2)}`;
                
                tableData.push([client, clientData[client].totalTrips, clientData[client].totalNetWt.toFixed(2), clientData[client].totalSaleAmount.toFixed(2), transactionsStr]);
            }
            
            doc.autoTable({
                head: [['Client Details', 'Total Trips', 'Total NET WT (MT)', 'Total Sale Amount', 'Transaction Details']],
                body: tableData,
                startY: 30,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [44, 62, 80] },
                alternateRowStyles: { fillColor: [240, 240, 240] }
            });
            
            doc.save(`Client_Dispatch_Bill_${startDate}_to_${endDate}${clientDetails ? `_${clientDetails.replace(/\s+/g, '_')}` : ''}.pdf`);
        }
        
        function downloadDispatchExcel() {
            if (!currentDispatchReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { date, shift, customerData, materialTypes } = currentDispatchReportData;
            
            const excelData = [];
            excelData.push([`${shift === "ALL" ? "FULL DAY" : shift} - Dispatch Vehicle Wise Planning - ${formatDate(date)}`]);
            excelData.push([]);
            
            // Create header row
            const headerRow = ['Client Details', 'Unit'];
            materialTypes.forEach(material => headerRow.push(material));
            headerRow.push('TOTAL');
            excelData.push(headerRow);
            
            // Add customer data
            for (const customer in customerData) {
                // Tonnage row
                const tonnageRow = [customer, 'Total Tonnage (MT)'];
                materialTypes.forEach(material => {
                    tonnageRow.push(customerData[customer].materials[material].tonnage > 0 ? customerData[customer].materials[material].tonnage.toFixed(2) : '');
                });
                tonnageRow.push(customerData[customer].totalTonnage.toFixed(2));
                excelData.push(tonnageRow);
                
                // Trips row
                const tripsRow = ['', 'Total Trips'];
                materialTypes.forEach(material => {
                    tripsRow.push(customerData[customer].materials[material].trips > 0 ? customerData[customer].materials[material].trips : '');
                });
                tripsRow.push(customerData[customer].totalTrips);
                excelData.push(tripsRow);
            }
            
            // Calculate totals
            const materialTotals = {};
            materialTypes.forEach(material => materialTotals[material] = { tonnage: 0, trips: 0 });
            
            let grandTotalTonnage = 0, grandTotalTrips = 0;
            for (const customer in customerData) {
                materialTypes.forEach(material => {
                    materialTotals[material].tonnage += customerData[customer].materials[material].tonnage;
                    materialTotals[material].trips += customerData[customer].materials[material].trips;
                });
                grandTotalTonnage += customerData[customer].totalTonnage;
                grandTotalTrips += customerData[customer].totalTrips;
            }
            
            // Add grand total row
            const grandTonnageRow = ['GRAND TOTAL', 'Total Tonnage (MT)'];
            materialTypes.forEach(material => {
                grandTonnageRow.push(materialTotals[material].tonnage > 0 ? materialTotals[material].tonnage.toFixed(2) : '');
            });
            grandTonnageRow.push(grandTotalTonnage.toFixed(2));
            excelData.push(grandTonnageRow);
            
            // Add total trips row
            const grandTripsRow = ['', 'Total Trips'];
            materialTypes.forEach(material => {
                grandTripsRow.push(materialTotals[material].trips > 0 ? materialTotals[material].trips : '');
            });
            grandTripsRow.push(grandTotalTrips);
            excelData.push(grandTripsRow);
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dispatch Report');
            
            // Save file
            XLSX.writeFile(wb, `Dispatch_Report_${date}_${shift}.xlsx`);
        }
        
        function downloadFtdExcel() {
            if (!currentFtdReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { date, shift, materialTypes, dayRecords, nightRecords, dayCustomerData, nightCustomerData } = currentFtdReportData;
            
            const excelData = [];
            excelData.push([`FTD Report - ${shift} - ${formatDate(date)}`]);
            excelData.push([]);
            
            // Calculate totals for day and night shifts
            let dayTotalTonnage = 0;
            let dayTotalTrips = 0;
            const dayMaterialTotals = {};
            materialTypes.forEach(material => dayMaterialTotals[material] = { tonnage: 0, trips: 0 });
            
            dayRecords.forEach(record => {
                dayTotalTonnage += record.netWt;
                dayTotalTrips += 1;
                if (dayMaterialTotals[record.materialType]) {
                    dayMaterialTotals[record.materialType].tonnage += record.netWt;
                    dayMaterialTotals[record.materialType].trips += 1;
                }
            });
            
            let nightTotalTonnage = 0;
            let nightTotalTrips = 0;
            const nightMaterialTotals = {};
            materialTypes.forEach(material => nightMaterialTotals[material] = { tonnage: 0, trips: 0 });
            
            nightRecords.forEach(record => {
                nightTotalTonnage += record.netWt;
                nightTotalTrips += 1;
                if (nightMaterialTotals[record.materialType]) {
                    nightMaterialTotals[record.materialType].tonnage += record.netWt;
                    nightMaterialTotals[record.materialType].trips += 1;
                }
            });
            
            // Add day shift data if applicable
            if (shift === "A-SHIFT" || shift === "ALL") {
                excelData.push(['A-SHIFT (Day Shift) – Dispatch Vehicle Wise Planning']);
                excelData.push([]);
                
                // Create header row
                const headerRow = ['Customer Name'];
                materialTypes.forEach(material => headerRow.push(material));
                headerRow.push('TOTAL');
                excelData.push(headerRow);
                
                // Add customer data
                for (const customer in dayCustomerData) {
                    const row = [customer];
                    materialTypes.forEach(material => {
                        row.push(dayCustomerData[customer].materials[material].tonnage > 0 ? dayCustomerData[customer].materials[material].tonnage.toFixed(2) : '');
                    });
                    row.push(dayCustomerData[customer].totalTonnage.toFixed(2));
                    excelData.push(row);
                }
                
                // Add day shift totals
                if (shift === "A-SHIFT") {
                    const totalRow = [`Total No of Vehicles: ${dayTotalTrips}`];
                    materialTypes.forEach(material => {
                        totalRow.push(dayMaterialTotals[material]?.tonnage > 0 ? dayMaterialTotals[material].tonnage.toFixed(2) : '');
                    });
                    totalRow.push(dayTotalTonnage.toFixed(2));
                    excelData.push(totalRow);
                }
                
                excelData.push([]);
            }
            
            // Add night shift data if applicable
            if (shift === "B-SHIFT" || shift === "ALL") {
                excelData.push(['B-SHIFT (Night Shift) – Dispatch Vehicle Wise Planning']);
                excelData.push([]);
                
                // Create header row
                const headerRow = ['Customer Name'];
                materialTypes.forEach(material => headerRow.push(material));
                headerRow.push('TOTAL');
                excelData.push(headerRow);
                
                // Add customer data
                for (const customer in nightCustomerData) {
                    const row = [customer];
                    materialTypes.forEach(material => {
                        row.push(nightCustomerData[customer].materials[material].tonnage > 0 ? nightCustomerData[customer].materials[material].tonnage.toFixed(2) : '');
                    });
                    row.push(nightCustomerData[customer].totalTonnage.toFixed(2));
                    excelData.push(row);
                }
                
                // Add night shift totals
                if (shift === "B-SHIFT") {
                    const totalRow = [`Total No of Vehicles: ${nightTotalTrips}`];
                    materialTypes.forEach(material => {
                        totalRow.push(nightMaterialTotals[material]?.tonnage > 0 ? nightMaterialTotals[material].tonnage.toFixed(2) : '');
                    });
                    totalRow.push(nightTotalTonnage.toFixed(2));
                    excelData.push(totalRow);
                }
                
                excelData.push([]);
            }
            
            // Add summary for FULL DAY report
            if (shift === "ALL") {
                excelData.push(['Summary']);
                excelData.push([]);
                
                // Create header row
                const headerRow = ['Shift', 'No of Vehicles'];
                materialTypes.forEach(material => headerRow.push(material));
                headerRow.push('Grand Total MT');
                excelData.push(headerRow);
                
                // Day shift summary
                const dayRow = ['Day Shift Total', dayTotalTrips];
                materialTypes.forEach(material => {
                    dayRow.push(dayMaterialTotals[material]?.tonnage > 0 ? dayMaterialTotals[material].tonnage.toFixed(2) : '');
                });
                dayRow.push(dayTotalTonnage.toFixed(2));
                excelData.push(dayRow);
                
                // Night shift summary
                const nightRow = ['Night Shift Total', nightTotalTrips];
                materialTypes.forEach(material => {
                    nightRow.push(nightMaterialTotals[material]?.tonnage > 0 ? nightMaterialTotals[material].tonnage.toFixed(2) : '');
                });
                nightRow.push(nightTotalTonnage.toFixed(2));
                excelData.push(nightRow);
                
                // Combined totals
                const combinedTotalTonnage = dayTotalTonnage + nightTotalTonnage;
                const combinedTotalTrips = dayTotalTrips + nightTotalTrips;
                
                const combinedRow = ['Combined Total (Day + Night)', combinedTotalTrips];
                materialTypes.forEach(material => {
                    const tonnage = (dayMaterialTotals[material]?.tonnage || 0) + (nightMaterialTotals[material]?.tonnage || 0);
                    combinedRow.push(tonnage > 0 ? tonnage.toFixed(2) : '');
                });
                combinedRow.push(combinedTotalTonnage.toFixed(2));
                excelData.push(combinedRow);
                
                excelData.push([]);
                excelData.push(['Overall Grand Total Vehicles:', combinedTotalTrips]);
                excelData.push(['Overall Grand Total MT:', combinedTotalTonnage.toFixed(2)]);
                
                // Calculate cash and credit sales
                let totalCashSale = 0;
                let totalCreditSale = 0;
                
                allRecords.filter(record => record.date === date).forEach(record => {
                    if (record.paymentMode === "Cash") {
                        totalCashSale += record.saleAmount;
                    } else if (record.paymentMode === "Credit") {
                        totalCreditSale += record.saleAmount;
                    }
                });
                
                excelData.push([]);
                excelData.push(['Total Cash Sale Amount:', `₹${totalCashSale.toFixed(2)}`]);
                excelData.push(['Total Credit Sale Amount:', `₹${totalCreditSale.toFixed(2)}`]);
            }
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'FTD Report');
            
            // Save file
            XLSX.writeFile(wb, `FTD_Report_${date}_${shift}.xlsx`);
        }
        
        function downloadTransportExcel() {
            if (!currentTransportReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { startDate, endDate, vehicleNo, vehicleData } = currentTransportReportData;
            
            const excelData = [];
            excelData.push([`Transport Bill Report - ${formatDate(startDate)} to ${formatDate(endDate)}${vehicleNo ? ` - Vehicle: ${vehicleNo}` : ''}`]);
            excelData.push([]);
            
            // Create header row
            const headerRow = ['Vehicle No', 'Total Trips', 'Total NET WT (MT)', 'Total Transport Amount', 'Transaction Details'];
            excelData.push(headerRow);
            
            // Add vehicle data
            for (const vehicle in vehicleData) {
                const transactions = vehicleData[vehicle].transactions.map(tx =>
                    `Slip No: ${tx.weighmentSlipNo}, Client: ${tx.clientDetails}, Material: ${tx.materialType}, Net WT: ${tx.netWt.toFixed(2)}, Transport Amount: ${tx.transportAmount.toFixed(2)}`
                ).join('; ');
                
                const row = [
                    vehicle,
                    vehicleData[vehicle].totalTrips,
                    vehicleData[vehicle].totalNetWt.toFixed(2),
                    vehicleData[vehicle].totalTransportAmount.toFixed(2),
                    transactions
                ];
                excelData.push(row);
            }
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transport Bill');
            
            // Save file
            XLSX.writeFile(wb, `Transport_Bill_${startDate}_to_${endDate}${vehicleNo ? `_${vehicleNo}` : ''}.xlsx`);
        }

        function downloadClientExcel() {
            if (!currentClientReportData) {
                alert("No report data available to download.");
                return;
            }
            
            const { startDate, endDate, clientDetails, clientData } = currentClientReportData;
            
            const excelData = [];
            excelData.push([`Client Wise Dispatch Bill Report - ${formatDate(startDate)} to ${formatDate(endDate)}${clientDetails ? ` - Client: ${clientDetails}` : ''}`]);
            excelData.push([]);
            
            // For each client, add header and totals, then transactions grouped by month
            for (const client in clientData) {
                excelData.push([`Client: ${client}`]);
                excelData.push(['Total Trips', clientData[client].totalTrips]);
                excelData.push(['Total NET WT (MT)', clientData[client].totalNetWt.toFixed(2)]);
                excelData.push(['Total Sale Amount', clientData[client].totalSaleAmount.toFixed(2)]);
                excelData.push([]);
                
                excelData.push(['Transactions:']);
                const transHeader = ['Date', 'Slip No', 'Material', 'Net WT', 'Rate', 'Amount', 'Vehicle'];
                excelData.push(transHeader);
                
                // Sort transactions by date
                clientData[client].transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                let currentMonth = '';
                let monthTrips = 0;
                let monthNetWt = 0;
                let monthSaleAmount = 0;
                
                clientData[client].transactions.forEach(tx => {
                    const monthYear = getMonthYear(tx.date);
                    if (monthYear !== currentMonth) {
                        if (currentMonth) {
                            // Add month total
                            excelData.push(['Month Total:', '', '', monthTrips, '', monthNetWt.toFixed(2), monthSaleAmount.toFixed(2), '']);
                        }
                        excelData.push([monthYear]);
                        currentMonth = monthYear;
                        monthTrips = 0;
                        monthNetWt = 0;
                        monthSaleAmount = 0;
                    }
                    
                    excelData.push([formatDate(tx.date), tx.weighmentSlipNo, tx.materialType, tx.netWt.toFixed(2), tx.ratePerTone.toFixed(2), tx.saleAmount.toFixed(2), tx.vehicleNo]);
                    
                    monthTrips += 1;
                    monthNetWt += tx.netWt;
                    monthSaleAmount += tx.saleAmount;
                });
                
                // Add last month total
                if (currentMonth) {
                    excelData.push(['Month Total:', '', '', monthTrips, '', monthNetWt.toFixed(2), monthSaleAmount.toFixed(2), '']);
                }
                
                // Add grand total
                excelData.push(['Grand Total:', '', '', clientData[client].totalTrips, '', clientData[client].totalNetWt.toFixed(2), clientData[client].totalSaleAmount.toFixed(2), '']);
                excelData.push([]);
                excelData.push([]);
            }
            
            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Client Dispatch Bill');
            
            // Save file
            XLSX.writeFile(wb, `Client_Dispatch_Bill_${startDate}_to_${endDate}${clientDetails ? `_${clientDetails.replace(/\s+/g, '_')}` : ''}.xlsx`);
        }
        
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(allRecords.map(record => ({
                'S.No': allRecords.indexOf(record) + 1,
                'Accounting Date': record.accountingDate,
                'Date': record.date,
                'Shift': record.shift,
                'Weighment Slip No': record.weighmentSlipNo,
                'DC No': record.deliveryChallanNo,
                'Royalty Permit No': record.royaltyPermitNo,
                'Permit Qty (CM)': record.permitQty.toFixed(2),
                'Client Details': record.clientDetails,
                'Payment Terms': record.paymentMode,
                'Transport Type': record.transportType,
                'Vehicle No': record.vehicleNo,
                'Material': record.materialType,
                'Gross WT': record.grossWt.toFixed(2),
                'Tare WT': record.tareWt.toFixed(2),
                'NET WT': record.netWt.toFixed(2),
                'Rate Per Tone': record.ratePerTone.toFixed(2),
                'Amount': record.saleAmount.toFixed(2),
                'Cash Received': record.cashReceived.toFixed(2),
                'Advance Received': record.advanceReceived.toFixed(2),
                'Customer Balance': record.customerBalance.toFixed(2),
                'Remarks': record.remarks,
                'Royalty Rate': record.royaltyRate.toFixed(2),
                'Royalty Amount': record.royaltyAmount.toFixed(2),
                'Transport Rate': record.transportRate.toFixed(2),
                'Transport Amount': record.transportAmount.toFixed(2),
                'Total Amount': record.totalAmount.toFixed(2)
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Records');
            XLSX.writeFile(wb, 'Weighbridge_Records.xlsx');
        }
    </script>
</body>
</html>
