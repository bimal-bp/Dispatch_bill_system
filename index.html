<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeighBridge & Transport Billing System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Add SheetJS library for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Add jsPDF library for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        .system-title {
            text-align: center;
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 25px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        .form-label {
            font-weight: 500;
            color: #007bff;
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #e9ecef;
            position: sticky;
            top: 0;
        }
        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .calculated {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        .section-header {
            background-color: #2c3e50;
            color: white;
            padding: 8px 15px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .report-section {
            margin-top: 30px;
        }
        .report-table {
            margin-top: 15px;
        }
        .shift-header {
            background-color: #ffc107;
            font-weight: bold;
            text-align: center;
        }
        .customer-header {
            background-color: #d8bfd8;
            font-weight: bold;
        }
        .total-header {
            background-color: #90ee90;
            font-weight: bold;
        }
        .number-cell {
            text-align: right;
        }
        .tipper-dropdown {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .transaction-details {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
        }
        .transaction-row {
            border-bottom: 1px solid #dee2e6;
            padding: 5px 0;
        }
        .transaction-row:last-child {
            border-bottom: none;
        }
        @media (max-width: 768px) {
            .btn-container {
                flex-direction: column;
            }
            .tipper-dropdown {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        .report-actions {
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .ftd-total-section {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .ftd-total-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: #0056b3;
            margin-bottom: 15px;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="system-title">Weighbridge Billing System</div>
       
        <form id="weighmentForm">
            <!-- Basic Information Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="accountingDate" class="form-label">Accounting Date</label>
                    <input type="date" class="form-control" id="accountingDate" required>
                </div>
                <div class="col-md-2">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="date" required>
                </div>
                <div class="col-md-2">
                    <label for="shift" class="form-label">Shift</label>
                    <select class="form-select" id="shift">
                        <option value="A-SHIFT">A-SHIFT</option>
                        <option value="B-SHIFT">B-SHIFT</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="weighmentSlipNo" class="form-label">Weighment Slip No</label>
                    <input type="text" class="form-control" id="weighmentSlipNo">
                </div>
                <div class="col-md-3">
                    <label for="deliveryChallanNo" class="form-label">DC No</label>
                    <input type="text" class="form-control" id="deliveryChallanNo">
                </div>
            </div>
            <!-- Royalty Information Section -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="royaltyPermitNo" class="form-label">Royalty Permit No</label>
                    <input type="text" class="form-control" id="royaltyPermitNo">
                </div>
                <div class="col-md-4">
                    <label for="permitQty" class="form-label">Permit Qty (CM)</label>
                    <input type="number" class="form-control" id="permitQty" step="0.01">
                </div>
                <div class="col-md-4">
                    <label for="royaltyRate" class="form-label">Royalty Rate</label>
                    <input type="number" class="form-control" id="royaltyRate" step="0.01">
                </div>
            </div>
            <div class="col-md-4">
                    <label for="paymentMode" class="form-label">Vehicle System</label>
                    <select class="form-select" id="paymentMode">
                        <option value="">Select Vehicle  Mode</option>
                        <option value="Cash"> Sgx Transport</option>
                        <option value="Credit"> Customer Transoprt</option>
                    </select>
           </div>
            <!-- Customer Information Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                </div>
                <div class="col-md-5">
                    <label for="customerName" class="form-label">Name of the Customer</label>
                    <input type="text" class="form-control" id="customerName">
                </div>
            </div>
            <!-- Payment Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="paymentMode" class="form-label">Payment Terms</label>
                    <select class="form-select" id="paymentMode">
                        <option value="">Select Payment Mode</option>
                        <option value="Cash">Cash</option>
                        <option value="Credit">Credit</option>
                        <option value="Credit">Credit-Cash-Pending</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="advanceReceived" class="form-label">Advance Received</label>
                    <input type="number" class="form-control" id="advanceReceived" step="0.01">
                </div>
            </div>
            <!-- Vehicle Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="vehicleNo" class="form-label">Vehicle No</label>
                    <div class="tipper-dropdown">
                        <select class="form-select" id="vehicleDropdown">
                            <option value="">Select Vehicle</option>
                            <option value="AP39UJ1166">AP39UJ1166</option>
                            <option value="AP39UJ2399">AP39UJ2399</option>
                            <option value="AP39UZ3659">AP39UZ3659</option>
                            <option value="AP39VF1899">AP39VF1899</option>
                            <option value="AP39UJ5678">AP39UJ5678</option>
                            <option value="AP39VF2339">AP39VF2339</option>
                            <option value="AP39W3579">AP39W3579</option>
                            <option value="AP39WC2389">AP39WC2389</option>
                            <option value="AP39TV2537">AP39TV2537</option>
                            <option value="AP39VE2979">AP39VE2979</option>
                            <option value="AP39WD5679">AP39WD5679</option>
                            <option value="AP31TN2579">AP31TN2579</option>
                            <option value="AP39UJ2489">AP39UJ2489</option>
                            <option value="AP39TV2536">AP39TV2536</option>
                            <option value="AP39WD8349">AP39WD8349</option>
                            <option value="AP39UY3345">AP39UY3345</option>
                            <option value="AP39UY3435">AP39UY3435</option>
                            <option value="AP39VC5289">AP39VC5289</option>
                            <option value="AP39WD4199">AP39WD4199</option>
                            <option value="AP39WC7449">AP39WC7449</option>
                            <option value="AP39UZ3335">AP39UZ3335</option>
                            <option value="AP39UH2489">AP39UH2489</option>
                            <option value="AP31TN4302">AP31TN4302</option>
                            <option value="AP39VB8829">AP39VB8829</option>
                            <option value="AP39UU5665">AP39UU5665</option>
                            <option value="AP39VB2427">AP39VB2427</option>
                            <option value="AP39UD1589">AP39UD1589</option>
                            <option value="AP39UF3245">AP39UF3245</option>
                            <option value="AP39UG0559">AP39UG0559</option>
                        </select>
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddVehicle">Add New</button>
                    </div>
                    <input type="text" class="form-control mt-2" id="vehicleNo" placeholder="Or enter vehicle number">
                </div>
                <div class="col-md-4">
                    <label for="transportRate" class="form-label">Transport Rate</label>
                    <input type="number" class="form-control" id="transportRate" step="0.01">
                </div>
            </div>
            <!-- Material Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="materialType" class="form-label">Material</label>
                    <select class="form-select" id="materialType">
                        <option value="">Select Material</option>
                        <option value="10 MM">10 MM</option>
                        <option value="20 MM">20 MM</option>
                        <option value="V/SAND">V/SAND</option>
                        <option value="Scalping">Scalping</option>
                        <option value="P/Sand">P/Sand</option>
                        <option value="40MM">40MM</option>
                        <option value="GSB/WET MIX">GSB/WET MIX</option>
                        <option value="R/Sand">R/Sand</option>
                    </select>
                </div>
            </div>
            <!-- Weighment Details Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="grossWt" class="form-label">Gross WT</label>
                    <input type="number" class="form-control" id="grossWt" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="tareWt" class="form-label">Tare WT</label>
                    <input type="number" class="form-control" id="tareWt" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="netWt" class="form-label">NET WT (Calculated)</label>
                    <input type="number" class="form-control calculated" id="netWt" readonly>
                </div>
                <div class="col-md-3">
                    <label for="ratePerTone" class="form-label">Rate Per Tone</label>
                    <input type="number" class="form-control" id="ratePerTone" step="0.01">
                </div>
            </div>
            <!-- Financial Information Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="saleAmount" class="form-label">Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="saleAmount" readonly>
                </div>
                <div class="col-md-3">
                    <label for="cashReceived" class="form-label">Cash Received</label>
                    <input type="number" class="form-control" id="cashReceived" step="0.01">
                </div>
                <div class="col-md-3">
                    <label for="customerBalance" class="form-label">Customer Balance Amount (₹)</label>
                    <input type="number" class="form-control calculated" id="customerBalance" readonly>
                </div>
                <div class="col-md-3">
                    <label for="royaltyAmount" class="form-label">Royalty Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="royaltyAmount" readonly>
                </div>
            </div>
            <!-- Additional Information -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="transportAmount" class="form-label">Transport Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="transportAmount" readonly>
                </div>
                <div class="col-md-4">
                    <label for="totalAmount" class="form-label">Total Amount (Calculated)</label>
                    <input type="number" class="form-control calculated" id="totalAmount" readonly>
                </div>
                <div class="col-md-4">
                    <label for="remarks" class="form-label">Remarks</label>
                    <input type="text" class="form-control" id="remarks">
                </div>
            </div>
            <!-- Action Buttons -->
            <div class="btn-container">
                <button type="submit" class="btn btn-success">Save Entry</button>
                <button type="button" class="btn btn-primary" id="btnExportExcel">Export to Excel</button>
            </div>
        </form>
    </div>
    <div class="container">
        <h2>Data Records</h2>
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="mainDataTable">
                <thead>
                    <tr>
                        <th>S.NO</th>
                        <th>Accounting Date</th>
                        <th>Date</th>
                        <th>Weighment Slip No</th>
                        <th>DC No</th>
                        <th>Royalty Permit No</th>
                        <th>Permit Qty (CM)</th>
                        <th>Customer Sr No</th>
                        <th>Customer Name</th>
                        <th>Client Details</th>
                        <th>Payment Terms</th>
                        <th>Vehicle No</th>
                        <th>Material</th>
                        <th>Gross WT</th>
                        <th>Tare WT</th>
                        <th>NET WT</th>
                        <th>Rate Per Tone</th>
                        <th>Amount</th>
                        <th>Cash Received</th>
                        <th>Advance Received</th>
                        <th>Customer Balance</th>
                        <th>Remarks</th>
                        <th>Royalty Rate</th>
                        <th>Royalty Amount</th>
                        <th>Transport Rate</th>
                        <th>Transport Amount</th>
                        <th>Total Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recordsTable">
                    <tr>
                        <td colspan="28" class="text-center">No records found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Reports Section -->
    <div class="container report-section">
        <h2>Reports</h2>
       
        <!-- Dispatch Vehicle Wise Planning Report -->
        <div class="section-header">Dispatch Vehicle Wise Planning Report</div>
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="dispatchReportDate" class="form-label">Select Date for Report</label>
                <input type="date" class="form-control" id="dispatchReportDate">
            </div>
            <div class="col-md-3">
                <label for="dispatchReportShift" class="form-label">Select Shift</label>
                <select class="form-select" id="dispatchReportShift">
                    <option value="A-SHIFT">A-SHIFT</option>
                    <option value="B-SHIFT">B-SHIFT</option>
                    <option value="ALL">FULL DAY</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btnDispatchReport">Generate Dispatch Report</button>
            </div>
        </div>
        <div class="report-actions" id="dispatchReportActions" style="display: none;">
            <button type="button" class="btn btn-success" id="btnDownloadDispatchPDF">Download PDF Report</button>
        </div>
        <div class="table-responsive">
            <div id="dispatchReportContainer"></div>
        </div>
        <!-- FTD (Full Truck Dispatch) Report -->
        <div class="section-header">FTD (Full Truck Dispatch) Report</div>
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="ftdReportDate" class="form-label">Select Date for Report</label>
                <input type="date" class="form-control" id="ftdReportDate">
            </div>
            <div class="col-md-3">
                <label for="ftdReportShift" class="form-label">Select Shift</label>
                <select class="form-select" id="ftdReportShift">
                    <option value="A-SHIFT">A-SHIFT</option>
                    <option value="B-SHIFT">B-SHIFT</option>
                    <option value="ALL">FULL DAY</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btnFtdReport">Generate FTD Report</button>
            </div>
        </div>
        <div class="report-actions" id="ftdReportActions" style="display: none;">
            <button type="button" class="btn btn-success" id="btnDownloadFtdPDF">Download PDF Report</button>
        </div>
        <div class="table-responsive">
            <div id="ftdReportContainer"></div>
        </div>
        <!-- FTD Total Report Section -->
        <div id="ftdTotalReportContainer" class="ftd-total-section" style="display: none;">
            <div class="ftd-total-title">FTD Total Report</div>
            <div class="table-responsive">
                <table class="table table-bordered" id="ftdTotalTable">
                    <thead>
                        <tr>
                            <th>Shift</th>
                            <th>Total Vehicles</th>
                            <th>Total Tonnage (MT)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-center">No data available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Transport Bill Report -->
        <div class="section-header">Transport Bill Report</div>
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="transportBillDate" class="form-label">Select Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="transportBillStartDate">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="transportBillEndDate">
                </div>
            </div>
            <div class="col-md-3">
                <label for="transportBillVehicle" class="form-label">Vehicle No (Optional)</label>
                <input type="text" class="form-control" id="transportBillVehicle" placeholder="Leave blank for all vehicles">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-primary form-control" id="btnTransportBill">Generate Transport Bill</button>
            </div>
        </div>
        <div class="report-actions" id="transportReportActions" style="display: none;">
            <button type="button" class="btn btn-success" id="btnDownloadTransportPDF">Download PDF Report</button>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered report-table" id="transportBillTable">
                <thead>
                    <tr>
                        <th>Vehicle No</th>
                        <th>Total Trips</th>
                        <th>Total NET WT (MT)</th>
                        <th>Total Transport Amount</th>
                        <th>Transaction Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center">No report generated yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Add Vehicle Modal -->
    <div class="modal fade" id="addVehicleModal" tabindex="-1" aria-labelledby="addVehicleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addVehicleModalLabel">Add New Vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newVehicleNo" class="form-label">Vehicle Number</label>
                        <input type="text" class="form-control" id="newVehicleNo">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveVehicle">Save Vehicle</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;
        // Store all records in an array for reporting
        let allRecords = [];
        let recordIdCounter = 1;
        let vehicleNumbers = [
            "AP39UJ1166", "AP39UJ2399", "AP39UZ3659", "AP39VF1899", "AP39UJ5678",
            "AP39VF2339", "AP39W3579", "AP39WC2389", "AP39TV2537", "AP39VE2979",
            "AP39WD5679", "AP31TN2579", "AP39UJ2489", "AP39TV2536", "AP39WD8349",
            "AP39UY3345", "AP39UY3435", "AP39VC5289", "AP39WD4199", "AP39WC7449",
            "AP39UZ3335", "AP39UH2489", "AP31TN4302", "AP39VB8829", "AP39UU5665",
            "AP39VB2427", "AP39UD1589", "AP39UF3245", "AP39UG0559"
        ];
        // Store report data for PDF export
        let currentDispatchReportData = null;
        let currentFtdReportData = null;
        let currentTransportReportData = null;
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize vehicle dropdown
            const vehicleDropdown = document.getElementById('vehicleDropdown');
            vehicleNumbers.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle;
                option.textContent = vehicle;
                vehicleDropdown.appendChild(option);
            });
           
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('accountingDate').value = today;
            document.getElementById('date').value = today;
            document.getElementById('dispatchReportDate').value = today;
            document.getElementById('ftdReportDate').value = today;
            document.getElementById('transportBillStartDate').value = today;
            document.getElementById('transportBillEndDate').value = today;
           
            // Event listeners for calculations
            document.getElementById('grossWt').addEventListener('input', calculateValues);
            document.getElementById('tareWt').addEventListener('input', calculateValues);
            document.getElementById('ratePerTone').addEventListener('input', calculateValues);
            document.getElementById('royaltyRate').addEventListener('input', calculateValues);
            document.getElementById('transportRate').addEventListener('input', calculateValues);
            document.getElementById('cashReceived').addEventListener('input', calculateValues);
            document.getElementById('advanceReceived').addEventListener('input', calculateValues);
           
            // Vehicle dropdown change event
            document.getElementById('vehicleDropdown').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('vehicleNo').value = this.value;
                }
            });
           
            // Add new vehicle button
            document.getElementById('btnAddVehicle').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addVehicleModal'));
                modal.show();
            });
           
            // Save new vehicle
            document.getElementById('btnSaveVehicle').addEventListener('click', function() {
                const newVehicleNo = document.getElementById('newVehicleNo').value.trim().toUpperCase();
                if (newVehicleNo && !vehicleNumbers.includes(newVehicleNo)) {
                    vehicleNumbers.push(newVehicleNo);
                   
                    // Add to dropdown
                    const option = document.createElement('option');
                    option.value = newVehicleNo;
                    option.textContent = newVehicleNo;
                    document.getElementById('vehicleDropdown').appendChild(option);
                   
                    // Set as selected
                    document.getElementById('vehicleDropdown').value = newVehicleNo;
                    document.getElementById('vehicleNo').value = newVehicleNo;
                   
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addVehicleModal'));
                    modal.hide();
                   
                    // Clear input
                    document.getElementById('newVehicleNo').value = '';
                } else if (vehicleNumbers.includes(newVehicleNo)) {
                    alert("This vehicle number already exists in the list.");
                } else {
                    alert("Please enter a valid vehicle number.");
                }
            });
           
            // Report generation buttons
            document.getElementById('btnDispatchReport').addEventListener('click', generateDispatchReport);
            document.getElementById('btnFtdReport').addEventListener('click', generateFtdReport);
            document.getElementById('btnTransportBill').addEventListener('click', generateTransportBill);
           
            // PDF download buttons
            document.getElementById('btnDownloadDispatchPDF').addEventListener('click', downloadDispatchPDF);
            document.getElementById('btnDownloadFtdPDF').addEventListener('click', downloadFtdPDF);
            document.getElementById('btnDownloadTransportPDF').addEventListener('click', downloadTransportPDF);
           
            // Form submission
            document.getElementById('weighmentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addRecord();
            });
           
            // Export to Excel button
            document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);
           
            function calculateValues() {
                // Calculate Net Weight
                const grossWt = parseFloat(document.getElementById('grossWt').value) || 0;
                const tareWt = parseFloat(document.getElementById('tareWt').value) || 0;
                const netWt = grossWt - tareWt;
                document.getElementById('netWt').value = netWt.toFixed(2);
               
                // Calculate Sale Amount
                const ratePerTone = parseFloat(document.getElementById('ratePerTone').value) || 0;
                const saleAmount = netWt * ratePerTone;
                document.getElementById('saleAmount').value = saleAmount.toFixed(2);
               
                // Calculate Royalty Amount
                const royaltyRate = parseFloat(document.getElementById('royaltyRate').value) || 0;
                const royaltyAmount = netWt * royaltyRate;
                document.getElementById('royaltyAmount').value = royaltyAmount.toFixed(2);
               
                // Calculate Transport Amount
                const transportRate = parseFloat(document.getElementById('transportRate').value) || 0;
                const transportAmount = netWt * transportRate;
                document.getElementById('transportAmount').value = transportAmount.toFixed(2);
               
                // Calculate Total Amount
                const totalAmount = saleAmount + royaltyAmount + transportAmount;
                document.getElementById('totalAmount').value = totalAmount.toFixed(2);
               
                // Calculate Customer Balance
                const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
                const advanceReceived = parseFloat(document.getElementById('advanceReceived').value) || 0;
                const customerBalance = totalAmount - cashReceived - advanceReceived;
                document.getElementById('customerBalance').value = customerBalance.toFixed(2);
            }
           
            function addRecord() {
                calculateValues();
               
                // Get form values
                const record = {
                    id: recordIdCounter++,
                    accountingDate: document.getElementById('accountingDate').value,
                    date: document.getElementById('date').value,
                    shift: document.getElementById('shift').value,
                    weighmentSlipNo: document.getElementById('weighmentSlipNo').value,
                    deliveryChallanNo: document.getElementById('deliveryChallanNo').value,
                    royaltyPermitNo: document.getElementById('royaltyPermitNo').value,
                    permitQty: parseFloat(document.getElementById('permitQty').value) || 0,
                    royaltyRate: parseFloat(document.getElementById('royaltyRate').value) || 0,
                    customerSrNo: document.getElementById('customerSrNo').value,
                    customerName: document.getElementById('customerName').value,
                    clientDetails: document.getElementById('clientDetails').value,
                    paymentMode: document.getElementById('paymentMode').value,
                    vehicleNo: document.getElementById('vehicleNo').value,
                    materialType: document.getElementById('materialType').value,
                    transportRate: parseFloat(document.getElementById('transportRate').value) || 0,
                    grossWt: parseFloat(document.getElementById('grossWt').value) || 0,
                    tareWt: parseFloat(document.getElementById('tareWt').value) || 0,
                    netWt: parseFloat(document.getElementById('netWt').value) || 0,
                    ratePerTone: parseFloat(document.getElementById('ratePerTone').value) || 0,
                    saleAmount: parseFloat(document.getElementById('saleAmount').value) || 0,
                    cashReceived: parseFloat(document.getElementById('cashReceived').value) || 0,
                    advanceReceived: parseFloat(document.getElementById('advanceReceived').value) || 0,
                    customerBalance: parseFloat(document.getElementById('customerBalance').value) || 0,
                    royaltyAmount: parseFloat(document.getElementById('royaltyAmount').value) || 0,
                    transportAmount: parseFloat(document.getElementById('transportAmount').value) || 0,
                    totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                    remarks: document.getElementById('remarks').value
                };
               
                // Add to records array
                allRecords.push(record);
               
                // Update the records table
                updateRecordsTable();
               
                // Reset the form
                document.getElementById('weighmentForm').reset();
               
                // Set default dates to today again
                document.getElementById('accountingDate').value = today;
                document.getElementById('date').value = today;
               
                alert("Record added successfully!");
            }
           
            function updateRecordsTable() {
                // Get the table body
                const tableBody = document.getElementById('recordsTable');
               
                // Clear the table
                tableBody.innerHTML = '';
               
                if (allRecords.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.textContent = 'No records found';
                    cell.colSpan = 28;
                    cell.className = 'text-center';
                    return;
                }
               
                // Add each record to the table
                allRecords.forEach((record, index) => {
                    const row = tableBody.insertRow();
                   
                    // Add cells with data
                    row.insertCell(0).textContent = index + 1;
                    row.insertCell(1).textContent = record.accountingDate;
                    row.insertCell(2).textContent = record.date;
                    row.insertCell(3).textContent = record.weighmentSlipNo;
                    row.insertCell(4).textContent = record.deliveryChallanNo;
                    row.insertCell(5).textContent = record.royaltyPermitNo;
                    row.insertCell(6).textContent = record.permitQty.toFixed(2);
                    row.insertCell(7).textContent = record.customerSrNo;
                    row.insertCell(8).textContent = record.customerName;
                    row.insertCell(9).textContent = record.clientDetails;
                    row.insertCell(10).textContent = record.paymentMode;
                    row.insertCell(11).textContent = record.vehicleNo;
                    row.insertCell(12).textContent = record.materialType;
                    row.insertCell(13).textContent = record.grossWt.toFixed(2);
                    row.insertCell(14).textContent = record.tareWt.toFixed(2);
                    row.insertCell(15).textContent = record.netWt.toFixed(2);
                    row.insertCell(16).textContent = record.ratePerTone.toFixed(2);
                    row.insertCell(17).textContent = record.saleAmount.toFixed(2);
                    row.insertCell(18).textContent = record.cashReceived.toFixed(2);
                    row.insertCell(19).textContent = record.advanceReceived.toFixed(2);
                    row.insertCell(20).textContent = record.customerBalance.toFixed(2);
                    row.insertCell(21).textContent = record.remarks;
                    row.insertCell(22).textContent = record.royaltyRate.toFixed(2);
                    row.insertCell(23).textContent = record.royaltyAmount.toFixed(2);
                    row.insertCell(24).textContent = record.transportRate.toFixed(2);
                    row.insertCell(25).textContent = record.transportAmount.toFixed(2);
                    row.insertCell(26).textContent = record.totalAmount.toFixed(2);
                   
                    // Add actions cell
                    const actionsCell = row.insertCell(27);
                    actionsCell.innerHTML = '<button class="btn btn-sm btn-info">View</button> <button class="btn btn-sm btn-danger">Delete</button>';
                   
                    // Add event listener to delete button
                    actionsCell.querySelector('.btn-danger').addEventListener('click', function() {
                        // Remove from records array
                        allRecords = allRecords.filter(r => r.id !== record.id);
                       
                        // Update the table
                        updateRecordsTable();
                    });
                });
            }
           
            function generateDispatchReport() {
                const reportDate = document.getElementById('dispatchReportDate').value;
                const reportShift = document.getElementById('dispatchReportShift').value;
               
                if (!reportDate) {
                    alert("Please select a date for the report.");
                    return;
                }
               
                // Filter records for the selected date and shift
                let dateRecords;
                if (reportShift === "ALL") {
                    dateRecords = allRecords.filter(record => record.date === reportDate);
                } else {
                    dateRecords = allRecords.filter(record => record.date === reportDate && record.shift === reportShift);
                }
               
                if (dateRecords.length === 0) {
                    alert("No records found for the selected criteria.");
                    document.getElementById('dispatchReportActions').style.display = 'none';
                    return;
                }
               
                // Group records by customer and material
                const customerData = {};
                const materialTypes = ["10 MM", "20 MM", "V/SAND", "Scalping", "P/Sand", "40MM", "GSB/WET MIX", "R/Sand"];
               
                dateRecords.forEach(record => {
                    if (!customerData[record.customerName]) {
                        customerData[record.customerName] = {
                            totalTonnage: 0,
                            totalTrips: 0,
                            materials: {}
                        };
                       
                        // Initialize all material types
                        materialTypes.forEach(material => {
                            customerData[record.customerName].materials[material] = {
                                tonnage: 0,
                                trips: 0
                            };
                        });
                    }
                   
                    // Add to total tonnage and trips
                    customerData[record.customerName].totalTonnage += record.netWt;
                    customerData[record.customerName].totalTrips += 1;
                   
                    // Add to specific material
                    if (customerData[record.customerName].materials[record.materialType]) {
                        customerData[record.customerName].materials[record.materialType].tonnage += record.netWt;
                        customerData[record.customerName].materials[record.materialType].trips += 1;
                    }
                });
               
                // Store data for PDF export
                currentDispatchReportData = {
                    date: reportDate,
                    shift: reportShift,
                    customerData: customerData,
                    materialTypes: materialTypes
                };
               
                // Show download button
                document.getElementById('dispatchReportActions').style.display = 'block';
               
                // Create report table
                let reportHTML = '<table class="table table-bordered">';
               
                // Add title row
                const formattedDate = formatDate(reportDate);
                if (reportShift === "ALL") {
                    reportHTML += `<tr class="shift-header"><th colspan="11">FULL DAY - Dispatch Vehicle Wise Planning - ${formattedDate}</th></tr>`;
                } else {
                    reportHTML += `<tr class="shift-header"><th colspan="11">${reportShift} - Dispatch Vehicle Wise Planning - ${formattedDate}</th></tr>`;
                }
               
                // Add header row
                reportHTML += '<tr class="customer-header">';
                reportHTML += '<th>Customer Name</th>';
                reportHTML += '<th>Unit</th>';
                materialTypes.forEach(material => {
                    reportHTML += `<th>${material}</th>`;
                });
                reportHTML += '<th>TOTAL</th>';
                reportHTML += '</tr>';
               
                // Add customer rows
                let grandTotalTonnage = 0;
                let grandTotalTrips = 0;
                const materialTotals = {};
                materialTypes.forEach(material => {
                    materialTotals[material] = { tonnage: 0, trips: 0 };
                });
               
                for (const customer in customerData) {
                    // Customer name row
                    reportHTML += `<tr><td rowspan="2" style="background-color: #d8bfd8; font-weight: bold;">${customer}</td><td>Total Tonnage (MT)</td>`;
                   
                    // Tonnage by material
                    materialTypes.forEach(material => {
                        const tonnage = customerData[customer].materials[material].tonnage;
                        reportHTML += `<td class="number-cell">${tonnage > 0 ? tonnage.toFixed(2) : ''}</td>`;
                        materialTotals[material].tonnage += tonnage;
                    });
                   
                    // Total tonnage for this customer
                    reportHTML += `<td class="number-cell">${customerData[customer].totalTonnage.toFixed(2)}</td>`;
                    grandTotalTonnage += customerData[customer].totalTonnage;
                   
                    reportHTML += '</tr>';
                   
                    // Trips row
                    reportHTML += `<tr><td>Total Trips</td>`;
                   
                    // Trips by material
                    materialTypes.forEach(material => {
                        const trips = customerData[customer].materials[material].trips;
                        reportHTML += `<td class="number-cell">${trips > 0 ? trips : ''}</td>`;
                        materialTotals[material].trips += trips;
                    });
                   
                    // Total trips for this customer
                    reportHTML += `<td class="number-cell">${customerData[customer].totalTrips}</td>`;
                    grandTotalTrips += customerData[customer].totalTrips;
                   
                    reportHTML += '</tr>';
                }
               
                // Add totals row
                reportHTML += '<tr class="total-header">';
                reportHTML += '<td colspan="2">TOTAL Tonnage (MT)</td>';
               
                // Tonnage totals by material
                materialTypes.forEach(material => {
                    reportHTML += `<td class="number-cell">${materialTotals[material].tonnage > 0 ? materialTotals[material].tonnage.toFixed(2) : ''}</td>`;
                });
               
                // Grand total tonnage
                reportHTML += `<td class="number-cell">${grandTotalTonnage.toFixed(2)}</td>`;
                reportHTML += '</tr>';
               
                // Trips totals row
                reportHTML += '<tr class="total-header">';
                reportHTML += '<td colspan="2">TOTAL Trips</td>';
               
                // Trips totals by material
                materialTypes.forEach(material => {
                    reportHTML += `<td class="number-cell">${materialTotals[material].trips > 0 ? materialTotals[material].trips : ''}</td>`;
                });
               
                // Grand total trips
                reportHTML += `<td class="number-cell">${grandTotalTrips}</td>`;
                reportHTML += '</tr>';
               
                reportHTML += '</table>';
               
                // Display the report
                document.getElementById('dispatchReportContainer').innerHTML = reportHTML;
            }
           
            function generateFtdReport() {
                const reportDate = document.getElementById('ftdReportDate').value;
                let reportShift = document.getElementById('ftdReportShift').value;
               
                if (!reportDate) {
                    alert("Please select a date for the report.");
                    return;
                }
               
                // Filter records for the selected date
                let dateRecords = allRecords.filter(record => record.date === reportDate);
               
                if (dateRecords.length === 0) {
                    alert("No records found for the selected criteria.");
                    document.getElementById('ftdReportActions').style.display = 'none';
                    document.getElementById('ftdTotalReportContainer').style.display = 'none';
                    return;
                }
               
                const formattedDate = formatDate(reportDate);
                let reportHTML = `<div style="text-align: right; margin-bottom: 10px;">Date: ${formattedDate}</div>`;
               
                let shiftsToProcess;
                if (reportShift === "ALL") {
                    const shiftSet = new Set(dateRecords.map(r => r.shift));
                    shiftsToProcess = Array.from(shiftSet).sort();
                } else {
                    shiftsToProcess = [reportShift];
                    dateRecords = dateRecords.filter(record => record.shift === reportShift);
                }
               
                // Prepare data for PDF and FTD Total Report
                currentFtdReportData = {
                    date: reportDate,
                    shifts: {}
                };
                
                // Prepare FTD Total data
                const ftdTotalData = [];
               
                shiftsToProcess.forEach(shiftValue => {
                    const shiftRecords = dateRecords.filter(record => record.shift === shiftValue);
                    if (shiftRecords.length === 0) return;
                   
                    // Group records by customer and material
                    const customerData = {};
                    const materialTypes = ["10 MM", "20 MM", "V/SAND", "Scalping", "P/Sand", "40MM", "GSB/WET MIX", "R/Sand"];
                   
                    // Overall for shift
                    const materialVehicleSets = {};
                    const grandVehicleSet = new Set();
                    let grandTotalTonnage = 0;
                    const materialTotals = {};
                    materialTypes.forEach(material => {
                        materialVehicleSets[material] = new Set();
                        materialTotals[material] = { tonnage: 0 };
                    });
                   
                    shiftRecords.forEach(record => {
                        if (!customerData[record.customerName]) {
                            customerData[record.customerName] = {
                                vehicles: new Set(),
                                materialVehicles: {},
                                totalTonnage: 0,
                                materials: {}
                            };
                            materialTypes.forEach(material => {
                                customerData[record.customerName].materialVehicles[material] = new Set();
                                customerData[record.customerName].materials[material] = { tonnage: 0 };
                            });
                        }
                       
                        // Add to customer
                        customerData[record.customerName].vehicles.add(record.vehicleNo);
                        customerData[record.customerName].totalTonnage += record.netWt;
                        customerData[record.customerName].materialVehicles[record.materialType].add(record.vehicleNo);
                        customerData[record.customerName].materials[record.materialType].tonnage += record.netWt;
                       
                        // Add to overall
                        grandVehicleSet.add(record.vehicleNo);
                        materialVehicleSets[record.materialType].add(record.vehicleNo);
                        materialTotals[record.materialType].tonnage += record.netWt;
                        grandTotalTonnage += record.netWt;
                    });
                   
                    // Store for PDF
                    currentFtdReportData.shifts[shiftValue] = {
                        customerData,
                        materialTypes,
                        materialVehicleSets,
                        grandVehicleSet,
                        grandTotalTonnage,
                        materialTotals
                    };
                    
                    // Add to FTD Total data
                    ftdTotalData.push({
                        shift: shiftValue,
                        totalVehicles: grandVehicleSet.size,
                        totalTonnage: grandTotalTonnage
                    });
                   
                    // Build HTML for this shift
                    reportHTML += '<table class="table table-bordered" style="margin-bottom: 20px;">';
                   
                    // Add shift title
                    reportHTML += `<tr class="shift-header"><th colspan="11">${shiftValue} - Dispatch Vehicle Wise Planning</th></tr>`;
                   
                    // Add header row
                    reportHTML += '<tr class="customer-header">';
                    reportHTML += '<th>Customer Name</th>';
                    reportHTML += '<th>Unit</th>';
                    materialTypes.forEach(material => {
                        reportHTML += `<th>${material}</th>`;
                    });
                    reportHTML += '<th>TOTAL</th>';
                    reportHTML += '</tr>';
                   
                    // Add customer rows
                    for (const customer in customerData) {
                        // Customer name row
                        reportHTML += `<tr><td rowspan="2" style="background-color: #d8bfd8; font-weight: bold;">${customer}</td><td>No. of Vehicles</td>`;
                       
                        // Vehicles by material
                        materialTypes.forEach(material => {
                            const count = customerData[customer].materialVehicles[material].size;
                            reportHTML += `<td class="number-cell">${count > 0 ? count : ''}</td>`;
                        });
                       
                        // Total vehicles for customer
                        reportHTML += `<td class="number-cell">${customerData[customer].vehicles.size}</td>`;
                        reportHTML += '</tr>';
                       
                        // Tonnage row
                        reportHTML += `<tr><td>Total Tonnage (MT)</td>`;
                       
                        // Tonnage by material
                        materialTypes.forEach(material => {
                            const tonnage = customerData[customer].materials[material].tonnage;
                            reportHTML += `<td class="number-cell">${tonnage > 0 ? tonnage.toFixed(2) : ''}</td>`;
                        });
                       
                        // Total tonnage for customer
                        reportHTML += `<td class="number-cell">${customerData[customer].totalTonnage.toFixed(2)}</td>`;
                        reportHTML += '</tr>';
                    }
                   
                    // Add totals rows
                    reportHTML += '<tr class="total-header">';
                    reportHTML += '<td colspan="2">Total No of Vehicles</td>';
                   
                    // Vehicles totals by material
                    materialTypes.forEach(material => {
                        const count = materialVehicleSets[material].size;
                        reportHTML += `<td class="number-cell">${count > 0 ? count : ''}</td>`;
                    });
                   
                    // Grand total vehicles
                    reportHTML += `<td class="number-cell">${grandVehicleSet.size}</td>`;
                    reportHTML += '</tr>';
                   
                    reportHTML += '<tr class="total-header">';
                    reportHTML += '<td colspan="2">Total Tonnage (MT)</td>';
                   
                    // Tonnage totals by material
                    materialTypes.forEach(material => {
                        reportHTML += `<td class="number-cell">${materialTotals[material].tonnage > 0 ? materialTotals[material].tonnage.toFixed(2) : ''}</td>`;
                    });
                   
                    // Grand total tonnage
                    reportHTML += `<td class="number-cell">${grandTotalTonnage.toFixed(2)}</td>`;
                    reportHTML += '</tr>';
                   
                    reportHTML += '</table>';
                });
               
                if (shiftsToProcess.length === 0) {
                    reportHTML += '<p>No data available for the selected shifts.</p>';
                }
               
                // Display the report
                document.getElementById('ftdReportContainer').innerHTML = reportHTML;
               
                // Show download button if data exists
                if (Object.keys(currentFtdReportData.shifts).length > 0) {
                    document.getElementById('ftdReportActions').style.display = 'block';
                } else {
                    document.getElementById('ftdReportActions').style.display = 'none';
                }
                
                // Generate FTD Total Report
                generateFtdTotalReport(ftdTotalData);
            }
            
            function generateFtdTotalReport(ftdTotalData) {
                if (ftdTotalData.length === 0) {
                    document.getElementById('ftdTotalReportContainer').style.display = 'none';
                    return;
                }
                
                // Show the FTD Total Report section
                document.getElementById('ftdTotalReportContainer').style.display = 'block';
                
                // Calculate grand totals
                let grandTotalVehicles = 0;
                let grandTotalTonnage = 0;
                
                ftdTotalData.forEach(data => {
                    grandTotalVehicles += data.totalVehicles;
                    grandTotalTonnage += data.totalTonnage;
                });
                
                // Update the FTD Total table
                const tableBody = document.querySelector('#ftdTotalTable tbody');
                tableBody.innerHTML = '';
                
                // Add shift rows
                ftdTotalData.forEach(data => {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = data.shift;
                    row.insertCell(1).textContent = data.totalVehicles;
                    row.insertCell(2).textContent = data.totalTonnage.toFixed(2);
                });
                
                // Add grand total row
                const totalRow = tableBody.insertRow();
                totalRow.classList.add('table-active', 'font-weight-bold');
                totalRow.insertCell(0).textContent = 'GRAND TOTAL';
                totalRow.insertCell(1).textContent = grandTotalVehicles;
                totalRow.insertCell(2).textContent = grandTotalTonnage.toFixed(2);
            }
           
            function generateTransportBill() {
                const startDate = document.getElementById('transportBillStartDate').value;
                const endDate = document.getElementById('transportBillEndDate').value;
                const vehicleNo = document.getElementById('transportBillVehicle').value.trim();
               
                if (!startDate || !endDate) {
                    alert("Please select a date range for the report.");
                    return;
                }
               
                // Filter records for the selected date range and optional vehicle
                let dateRecords;
                if (vehicleNo) {
                    dateRecords = allRecords.filter(record =>
                        record.date >= startDate &&
                        record.date <= endDate &&
                        record.vehicleNo === vehicleNo
                    );
                } else {
                    dateRecords = allRecords.filter(record =>
                        record.date >= startDate &&
                        record.date <= endDate
                    );
                }
               
                if (dateRecords.length === 0) {
                    alert("No records found for the selected criteria.");
                    document.getElementById('transportReportActions').style.display = 'none';
                    return;
                }
               
                // Group records by vehicle
                const vehicleData = {};
               
                dateRecords.forEach(record => {
                    if (!vehicleData[record.vehicleNo]) {
                        vehicleData[record.vehicleNo] = {
                            trips: 0,
                            totalTonnage: 0,
                            transportAmount: 0,
                            transactions: []
                        };
                    }
                   
                    vehicleData[record.vehicleNo].trips += 1;
                    vehicleData[record.vehicleNo].totalTonnage += record.netWt;
                    vehicleData[record.vehicleNo].transportAmount += record.transportAmount;
                    vehicleData[record.vehicleNo].transactions.push({
                        date: record.date,
                        shift: record.shift,
                        customerName: record.customerName,
                        material: record.materialType,
                        netWt: record.netWt,
                        transportRate: record.transportRate,
                        transportAmount: record.transportAmount
                    });
                });
               
                // Sort transactions by date
                for (const vehicle in vehicleData) {
                    vehicleData[vehicle].transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                }
               
                // Store data for PDF export
                currentTransportReportData = {
                    startDate: startDate,
                    endDate: endDate,
                    vehicleNo: vehicleNo,
                    vehicleData: vehicleData
                };
               
                // Show download button
                document.getElementById('transportReportActions').style.display = 'block';
               
                // Update the report table
                const tableBody = document.querySelector('#transportBillTable tbody');
                tableBody.innerHTML = '';
               
                let totalTransportAmount = 0;
                let totalTonnage = 0;
                let totalTrips = 0;
               
                for (const vehicle in vehicleData) {
                    const data = vehicleData[vehicle];
                   
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = vehicle;
                    row.insertCell(1).textContent = data.trips;
                    row.insertCell(2).textContent = data.totalTonnage.toFixed(2);
                    row.insertCell(3).textContent = data.transportAmount.toFixed(2);
                   
                    // Create transaction details cell
                    const detailsCell = row.insertCell(4);
                   
                    let detailsHTML = '<div class="transaction-details">';
                    detailsHTML += '<strong>Transaction Details:</strong>';
                   
                    data.transactions.forEach(transaction => {
                        detailsHTML += `
                            <div class="transaction-row">
                                <div>Date: ${transaction.date} (${transaction.shift})</div>
                                <div>Client: ${transaction.customerName}</div>
                                <div>Material: ${transaction.material}</div>
                                <div>Net WT: ${transaction.netWt.toFixed(2)} MT</div>
                                <div>Rate: ₹${transaction.transportRate.toFixed(2)}</div>
                                <div>Amount: ₹${transaction.transportAmount.toFixed(2)}</div>
                            </div>
                        `;
                    });
                   
                    detailsHTML += '</div>';
                    detailsCell.innerHTML = detailsHTML;
                   
                    totalTransportAmount += data.transportAmount;
                    totalTonnage += data.totalTonnage;
                    totalTrips += data.trips;
                }
               
                // Add total row
                const totalRow = tableBody.insertRow();
                totalRow.classList.add('table-active');
                totalRow.insertCell(0).textContent = 'TOTAL';
                totalRow.insertCell(1).textContent = totalTrips;
                totalRow.insertCell(2).textContent = totalTonnage.toFixed(2);
                totalRow.insertCell(3).textContent = totalTransportAmount.toFixed(2);
                totalRow.insertCell(4).textContent = '';
            }
           
            function downloadDispatchPDF() {
                if (!currentDispatchReportData) {
                    alert("No dispatch report data available to download.");
                    return;
                }
               
                const { date, shift, customerData, materialTypes } = currentDispatchReportData;
               
                // Create new PDF document
                const doc = new jsPDF();
               
                // Add title
                const formattedDate = formatDate(date);
                const title = shift === "ALL"
                    ? `FULL DAY - Dispatch Vehicle Wise Planning - ${formattedDate}`
                    : `${shift} - Dispatch Vehicle Wise Planning - ${formattedDate}`;
               
                doc.setFontSize(16);
                doc.text(title, 14, 15);
               
                // Prepare table data
                const tableData = [];
                const headers = ['Customer Name', 'Unit', ...materialTypes, 'TOTAL'];
               
                // Add customer data
                for (const customer in customerData) {
                    const data = customerData[customer];
                   
                    // Tonnage row
                    const tonnageRow = [customer, 'Total Tonnage (MT)'];
                    materialTypes.forEach(material => {
                        tonnageRow.push(data.materials[material].tonnage > 0 ? data.materials[material].tonnage.toFixed(2) : '');
                    });
                    tonnageRow.push(data.totalTonnage.toFixed(2));
                    tableData.push(tonnageRow);
                   
                    // Trips row
                    const tripsRow = ['', 'Total Trips'];
                    materialTypes.forEach(material => {
                        tripsRow.push(data.materials[material].trips > 0 ? data.materials[material].trips : '');
                    });
                    tripsRow.push(data.totalTrips);
                    tableData.push(tripsRow);
                   
                    // Empty row for spacing
                    tableData.push(['', '', '', '', '', '', '', '', '', '', '']);
                }
               
                // Add table to PDF
                doc.autoTable({
                    head: [headers],
                    body: tableData,
                    startY: 25,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [100, 100, 100] }
                });
               
                // Save the PDF
                const fileName = `Dispatch_Report_${date}_${shift.replace(' ', '_')}.pdf`;
                doc.save(fileName);
            }
           
            function downloadFtdPDF() {
                if (!currentFtdReportData) {
                    alert("No FTD report data available to download.");
                    return;
                }
               
                const { date, shifts } = currentFtdReportData;
               
                // Create new PDF document
                const doc = new jsPDF();
               
                // Add date
                const formattedDate = formatDate(date);
                doc.setFontSize(12);
                doc.text(`Date: ${formattedDate}`, 170, 15, { align: 'right' });
               
                let startY = 25;
               
                for (const shiftValue in shifts) {
                    const { customerData, materialTypes, materialVehicleSets, grandVehicleSet, grandTotalTonnage, materialTotals } = shifts[shiftValue];
                   
                    // Add shift title
                    doc.setFontSize(14);
                    doc.text(`${shiftValue} - Dispatch Vehicle Wise Planning`, 14, startY);
                    startY += 10;
                   
                    // Prepare table data
                    const tableData = [];
                    const headers = ['Customer Name', 'Unit', ...materialTypes, 'TOTAL'];
                   
                    // Add customer data
                    for (const customer in customerData) {
                        const data = customerData[customer];
                       
                        // Vehicles row
                        const vehiclesRow = [customer, 'No. of Vehicles'];
                        materialTypes.forEach(material => {
                            vehiclesRow.push(data.materialVehicles[material].size > 0 ? data.materialVehicles[material].size : '');
                        });
                        vehiclesRow.push(data.vehicles.size);
                        tableData.push(vehiclesRow);
                       
                        // Tonnage row
                        const tonnageRow = ['', 'Total Tonnage (MT)'];
                        materialTypes.forEach(material => {
                            tonnageRow.push(data.materials[material].tonnage > 0 ? data.materials[material].tonnage.toFixed(2) : '');
                        });
                        tonnageRow.push(data.totalTonnage.toFixed(2));
                        tableData.push(tonnageRow);
                       
                        // Empty row for spacing
                        tableData.push(['', '', '', '', '', '', '', '', '', '', '']);
                    }
                   
                    // Add totals
                    const totalVehiclesRow = ['TOTAL', 'No. of Vehicles'];
                    materialTypes.forEach(material => {
                        totalVehiclesRow.push(materialVehicleSets[material].size > 0 ? materialVehicleSets[material].size : '');
                    });
                    totalVehiclesRow.push(grandVehicleSet.size);
                    tableData.push(totalVehiclesRow);
                   
                    const totalTonnageRow = ['', 'Total Tonnage (MT)'];
                    materialTypes.forEach(material => {
                        totalTonnageRow.push(materialTotals[material].tonnage > 0 ? materialTotals[material].tonnage.toFixed(2) : '');
                    });
                    totalTonnageRow.push(grandTotalTonnage.toFixed(2));
                    tableData.push(totalTonnageRow);
                   
                    // Add table to PDF
                    doc.autoTable({
                        head: [headers],
                        body: tableData,
                        startY: startY,
                        theme: 'grid',
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [100, 100, 100] },
                        didParseCell: function (data) {
                            if (data.row.section === 'body' && data.column.index === 0 && data.row.span === 2) {
                                data.cell.styles.fillColor = [216, 191, 216]; // light purple
                            }
                            if (data.row.cells[0].text[0] === 'TOTAL') {
                                data.row.cells.forEach(cell => {
                                    cell.styles.fillColor = [144, 238, 144]; // green
                                    cell.styles.fontStyle = 'bold';
                                });
                            }
                        }
                    });
                   
                    startY = doc.lastAutoTable.finalY + 20;
                   
                    if (startY > 250) {
                        doc.addPage();
                        startY = 20;
                    }
                }
               
                // Save the PDF
                const fileName = `FTD_Report_${date}.pdf`;
                doc.save(fileName);
            }
           
            function downloadTransportPDF() {
                if (!currentTransportReportData) {
                    alert("No transport report data available to download.");
                    return;
                }
               
                const { startDate, endDate, vehicleNo, vehicleData } = currentTransportReportData;
               
                // Create new PDF document
                const doc = new jsPDF();
               
                // Add title
                const title = `Transport Bill Report - ${formatDate(startDate)} to ${formatDate(endDate)}`;
                if (vehicleNo) {
                    doc.setFontSize(16);
                    doc.text(title, 14, 15);
                    doc.setFontSize(12);
                    doc.text(`Vehicle: ${vehicleNo}`, 14, 25);
                } else {
                    doc.setFontSize(16);
                    doc.text(title, 14, 15);
                }
               
                // Prepare table data
                const tableData = [];
               
                for (const vehicle in vehicleData) {
                    const data = vehicleData[vehicle];
                   
                    // Add vehicle header
                    tableData.push([{content: `Vehicle: ${vehicle}`, colSpan: 5, styles: {fillColor: [200, 200, 200]}}]);
                   
                    // Add transaction headers
                    tableData.push(['Date', 'Client', 'Material', 'Net WT (MT)', 'Amount (₹)']);
                   
                    // Add transactions
                    data.transactions.forEach(transaction => {
                        tableData.push([
                            `${transaction.date} (${transaction.shift})`,
                            transaction.customerName,
                            transaction.material,
                            transaction.netWt.toFixed(2),
                            transaction.transportAmount.toFixed(2)
                        ]);
                    });
                   
                    // Add vehicle totals
                    tableData.push([
                        {content: 'TOTAL', colSpan: 3, styles: {fontStyle: 'bold'}},
                        data.totalTonnage.toFixed(2),
                        data.transportAmount.toFixed(2)
                    ]);
                   
                    // Add empty row for spacing
                    tableData.push(['', '', '', '', '']);
                }
               
                // Add table to PDF
                doc.autoTable({
                    body: tableData,
                    startY: vehicleNo ? 30 : 25,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [100, 100, 100] }
                });
               
                // Save the PDF
                const fileName = `Transport_Bill_${startDate}_to_${endDate}${vehicleNo ? '_' + vehicleNo : ''}.pdf`;
                doc.save(fileName);
            }
           
            function exportToExcel() {
                if (allRecords.length === 0) {
                    alert("No records to export.");
                    return;
                }
               
                // Prepare data for export
                const data = allRecords.map(record => ({
                    "S.NO": record.id,
                    "Accounting Date": record.accountingDate,
                    "Date": record.date,
                    "Weighment Slip No": record.weighmentSlipNo,
                    "DC No": record.deliveryChallanNo,
                    "Royalty Permit No": record.royaltyPermitNo,
                    "Permit Qty (CM)": record.permitQty,
                    "Customer Sr No": record.customerSrNo,
                    "Customer Name": record.customerName,
                    "Client Details": record.clientDetails,
                    "Payment Terms": record.paymentMode,
                    "Vehicle No": record.vehicleNo,
                    "Material": record.materialType,
                    "Gross WT": record.grossWt,
                    "Tare WT": record.tareWt,
                    "NET WT": record.netWt,
                    "Rate Per Tone": record.ratePerTone,
                    "Amount": record.saleAmount,
                    "Cash Received": record.cashReceived,
                    "Advance Received": record.advanceReceived,
                    "Customer Balance": record.customerBalance,
                    "Remarks": record.remarks,
                    "Royalty Rate": record.royaltyRate,
                    "Royalty Amount": record.royaltyAmount,
                    "Transport Rate": record.transportRate,
                    "Transport Amount": record.transportAmount,
                    "Total Amount": record.totalAmount
                }));
               
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(data);
               
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Weighment Records");
               
                // Generate file name with current date
                const fileName = `Weighment_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
               
                // Export to Excel
                XLSX.writeFile(wb, fileName);
            }
           
            function formatDate(dateString) {
                const date = new Date(dateString);
                const day = date.getDate();
                const month = date.toLocaleString('default', { month: 'short' }).toUpperCase();
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            }
           
            // Initialize the records table
            updateRecordsTable();
        });
    </script>
</body>
</html>
